
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Consumer Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../Stream/" />
    
    
    <link rel="prev" href="../Producer-scala/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../">
            
                <a href="../">
            
                    
                    Kafka
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Producer/">
            
                <a href="../Producer/">
            
                    
                    Producer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Producer-scala/">
            
                <a href="../Producer-scala/">
            
                    
                    Producer-Scala
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.3" data-path="./">
            
                <a href="./">
            
                    
                    Consumer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Stream/">
            
                <a href="../Stream/">
            
                    
                    Stream
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../Connector/">
            
                <a href="../Connector/">
            
                    
                    Connector
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../kafka-HA.html">
            
                <a href="../kafka-HA.html">
            
                    
                    Kafka High Availability
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="../kafka-controller.html">
            
                <a href="../kafka-controller.html">
            
                    
                    Kafka Controller
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="../Source-code-analysis/">
            
                <a href="../Source-code-analysis/">
            
                    
                    Kafka Source Code Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.8.1" data-path="../Source-code-analysis/kafka-schedule.html">
            
                <a href="../Source-code-analysis/kafka-schedule.html">
            
                    
                    Kafka Schedule
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.2" data-path="../Source-code-analysis/kafka-zkUtils.html">
            
                <a href="../Source-code-analysis/kafka-zkUtils.html">
            
                    
                    Zookeeper Utils
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.3" data-path="../Source-code-analysis/kafka-metric-reporter.html">
            
                <a href="../Source-code-analysis/kafka-metric-reporter.html">
            
                    
                    Metric Reporter
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.4" data-path="../Source-code-analysis/kafka-log-manager.html">
            
                <a href="../Source-code-analysis/kafka-log-manager.html">
            
                    
                    Log Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.5" data-path="../Source-code-analysis/kafka-metadata-cache.html">
            
                <a href="../Source-code-analysis/kafka-metadata-cache.html">
            
                    
                    Metadata Cache
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.6" data-path="../Source-code-analysis/kafka-socketserver.html">
            
                <a href="../Source-code-analysis/kafka-socketserver.html">
            
                    
                    Socketserver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.7" data-path="../Source-code-analysis/kafka-logappend.html">
            
                <a href="../Source-code-analysis/kafka-logappend.html">
            
                    
                    LogAppend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.8" data-path="../Source-code-analysis/kafka-isr.html">
            
                <a href="../Source-code-analysis/kafka-isr.html">
            
                    
                    ISR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.9" data-path="../Source-code-analysis/kafka-replica-manager.html">
            
                <a href="../Source-code-analysis/kafka-replica-manager.html">
            
                    
                    Replica Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.10" data-path="../Source-code-analysis/kafka-controller.html">
            
                <a href="../Source-code-analysis/kafka-controller.html">
            
                    
                    Kafka Controller
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.11" data-path="../Source-code-analysis/kafka-admin-manager.html">
            
                <a href="../Source-code-analysis/kafka-admin-manager.html">
            
                    
                    Admin Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.12" data-path="../Source-code-analysis/kafka-group-coordinator.html">
            
                <a href="../Source-code-analysis/kafka-group-coordinator.html">
            
                    
                    Group Coordinator
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.13" data-path="../Source-code-analysis/kafka-transaction-coordinator.html">
            
                <a href="../Source-code-analysis/kafka-transaction-coordinator.html">
            
                    
                    Transaction Coordinator
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.14" data-path="../Source-code-analysis/kafka-authorizer.html">
            
                <a href="../Source-code-analysis/kafka-authorizer.html">
            
                    
                    Authorizer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.15" data-path="../Source-code-analysis/kafka-apis.html">
            
                <a href="../Source-code-analysis/kafka-apis.html">
            
                    
                    Kafka APIs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.16" data-path="../Source-code-analysis/kafka-dynamic-config-manager.html">
            
                <a href="../Source-code-analysis/kafka-dynamic-config-manager.html">
            
                    
                    Dynamic Config Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.17" data-path="../Source-code-analysis/kafka-health-checker.html">
            
                <a href="../Source-code-analysis/kafka-health-checker.html">
            
                    
                    Health Checker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8.18" data-path="../Source-code-analysis/kafka-checkpoint.html">
            
                <a href="../Source-code-analysis/kafka-checkpoint.html">
            
                    
                    Checkpoint
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../Zookeeper/">
            
                <a href="../../Zookeeper/">
            
                    
                    Zookeeper
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../Zookeeper/getting-start.html">
            
                <a href="../../Zookeeper/getting-start.html">
            
                    
                    Zookeeper getting start
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../../Zookeeper/managing-configuration.html">
            
                <a href="../../Zookeeper/managing-configuration.html">
            
                    
                    Managing Configuration
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../Hadoop/">
            
                <a href="../../Hadoop/">
            
                    
                    Hadoop Ecosystem
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../../Hadoop/HBase/">
            
                <a href="../../Hadoop/HBase/">
            
                    
                    HBase
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="../../Hadoop/HBase/getting-start.html">
            
                <a href="../../Hadoop/HBase/getting-start.html">
            
                    
                    HBase getting start
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="../../Hadoop/HBase/hbase-shell.html">
            
                <a href="../../Hadoop/HBase/hbase-shell.html">
            
                    
                    HBase Shell
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../../Hadoop/Hive/">
            
                <a href="../../Hadoop/Hive/">
            
                    
                    Hive
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="../../Hadoop/Hive/tutorial.html">
            
                <a href="../../Hadoop/Hive/tutorial.html">
            
                    
                    Hive Tutorial
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.2" data-path="../../Hadoop/Hive/shell-command.html">
            
                <a href="../../Hadoop/Hive/shell-command.html">
            
                    
                    Hive Shell Command
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.3" data-path="../../Hadoop/Hive/HiveQL.html">
            
                <a href="../../Hadoop/Hive/HiveQL.html">
            
                    
                    HiveQL
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../../Hadoop/Sqoop/">
            
                <a href="../../Hadoop/Sqoop/">
            
                    
                    Sqoop
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.3.1" data-path="../../Hadoop/Sqoop/tutorial.html">
            
                <a href="../../Hadoop/Sqoop/tutorial.html">
            
                    
                    Sqoop Tutorial
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../../2017/">
            
                <a href="../../2017/">
            
                    
                    2017
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../../2017/load-unload-jar.html">
            
                <a href="../../2017/load-unload-jar.html">
            
                    
                    (un)load Jar
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../../2017/somthing-with-git.html">
            
                <a href="../../2017/somthing-with-git.html">
            
                    
                    Somthing with Git
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../Angular2/">
            
                <a href="../../Angular2/">
            
                    
                    Angular2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../../Docker/">
            
                <a href="../../Docker/">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../../Confluent/">
            
                <a href="../../Confluent/">
            
                    
                    Confluent
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../../Gobblin/">
            
                <a href="../../Gobblin/">
            
                    
                    Gobblin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../../Gradle/">
            
                <a href="../../Gradle/">
            
                    
                    Gradle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../../Log4j/">
            
                <a href="../../Log4j/">
            
                    
                    Log4j
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../../Java/NIO-IO.html">
            
                <a href="../../Java/NIO-IO.html">
            
                    
                    Java NIO vs IO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../../Cassandra/">
            
                <a href="../../Cassandra/">
            
                    
                    Cassandra
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="../../Logrotate/">
            
                <a href="../../Logrotate/">
            
                    
                    Logrotate
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Consumer</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="producer">Producer</h1>
<h2 id="consumer-exampleold-and-high-level">Consumer Example(old and high-level)</h2>
<p>&#x6D88;&#x8D39;&#x8005;&#x793A;&#x4F8B;, &#x6307;&#x5B9A;&#x8981;&#x6D88;&#x8D39;&#x7684;topic&#x548C;&#x7EBF;&#x7A0B;&#x6570;,&#x8FD4;&#x56DE;&#x6BCF;&#x4E2A;topic&#x5BF9;&#x5E94;&#x7684; KafkaStream&#x5217;&#x8868;,&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;KafkaStream.
&#x4E0B;&#x9762;&#x7684;&#x793A;&#x4F8B;&#x4E2D;&#x53EA;&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;,&#x6240;&#x4EE5;&#x901A;&#x8FC7;streams.get(0)&#x83B7;&#x53D6;&#x5230;&#x8BE5;&#x7EBF;&#x7A0B;&#x5BF9;&#x5E94;&#x7684;KafkaStream.&#x7136;&#x540E;&#x4ECE;&#x6D41;&#x4E2D;&#x8BFB;&#x53D6;&#x51FA;&#x6D88;&#x606F;.
topicCountMap&#x8868;&#x793A;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x6D88;&#x8D39;&#x591A;&#x4E2A; topic,&#x90A3;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8BBE;&#x7F6E;&#x7EBF;&#x7A0B;&#x6570;&#x5462;? &#x56E0;&#x4E3A;&#x4E00;&#x4E2A;topic&#x6709;&#x591A;&#x4E2A; partition&#x5206;&#x5E03;&#x5728;
&#x591A;&#x4E2A;broker&#x8282;&#x70B9;&#x4E0A;.&#x5373;&#x4F7F;&#x662F;&#x540C;&#x4E00;&#x4E2A;broker,&#x4E5F;&#x53EF;&#x80FD;&#x6709;&#x8FD9;&#x4E2A;topic&#x7684;&#x591A;&#x4E2A; partition. &#x7528;&#x4E0D;&#x540C;&#x7684;&#x7EBF;&#x7A0B;&#x6765;&#x9694;&#x79BB;&#x4E0D;&#x540C;&#x7684;partition.</p>
<pre><code class="lang-java">    ConsumerConfig conf = <span class="hljs-keyword">new</span> ConsumerConfig(props);
    ConsumerConnector consumer = kafka.consumer.Consumer.createJavaConsumerConnector(conf);
    Map&lt;String, Integer&gt; topicCountMap = <span class="hljs-keyword">new</span> HashMap&lt;String, Integer&gt;();
    topicCountMap.put(topic, <span class="hljs-keyword">new</span> Integer(<span class="hljs-number">1</span>));
    Map&lt;String, List&lt;KafkaStream&lt;<span class="hljs-keyword">byte</span>[], <span class="hljs-keyword">byte</span>[]&gt;&gt;&gt; consumerMap = consumer.createMessageStreams(topicCountMap);

    List&lt;KafkaStream&lt;<span class="hljs-keyword">byte</span>[], <span class="hljs-keyword">byte</span>[]&gt;&gt; streams = consumerMap.get(topic);
    KafkaStream&lt;<span class="hljs-keyword">byte</span>[], <span class="hljs-keyword">byte</span>[]&gt; stream = streams.get(<span class="hljs-number">0</span>); 
    ConsumerIterator&lt;<span class="hljs-keyword">byte</span>[], <span class="hljs-keyword">byte</span>[]&gt; it = stream.iterator();
    <span class="hljs-keyword">while</span> (it.hasNext()){
        System.out.println(<span class="hljs-string">&quot;message: &quot;</span> + <span class="hljs-keyword">new</span> String(it.next().message()));
    }
</code></pre>
<h2 id="consumerconnector">ConsumerConnector</h2>
<p>Consumer&#x5B9A;&#x4E49;&#x5728; ConsumerConnector&#x63A5;&#x53E3;&#x540C;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;. &#x5B83;&#x9ED8;&#x8BA4;&#x521B;&#x5EFA;&#x7684;ConsumerConnector&#x662F;&#x57FA;&#x4E8E; ZK&#x7684; ZookeeperConsumerConnector</p>
<pre><code class="lang-scala">    <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Consumer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Logging</span> </span>{
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createJavaConsumerConnector</span></span>(config: <span class="hljs-type">ConsumerConfig</span>): kafka.javaapi.consumer.<span class="hljs-type">ConsumerConnector</span> = {
            <span class="hljs-keyword">val</span> consumerConnect = <span class="hljs-keyword">new</span> kafka.javaapi.consumer.<span class="hljs-type">ZookeeperConsumerConnector</span>(config)
            consumerConnect
        }
    }
</code></pre>
<p>ConsumerConnector&#x4E3B;&#x8981;&#x6709;&#x521B;&#x5EFA;&#x6D88;&#x606F;&#x6D41;(createMessageStreams)&#x548C;&#x63D0;&#x4EA4;offset(commitOffsets)&#x4E24;&#x79CD;&#x65B9;&#x6CD5;.
Consumer&#x4F1A;&#x6839;&#x636E;&#x6D88;&#x606F;&#x6D41;&#x6D88;&#x8D39;&#x6570;&#x636E;, &#x5E76;&#x4E14;&#x5B9A;&#x65F6;&#x63D0;&#x4EA4;offset.&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#x81EA;&#x5DF1;&#x4FDD;&#x5B58;offset&#x662F; kafka&#x91C7;&#x7528; pull&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x7684;&#x4E00;&#x4E2A;&#x9644;&#x5E26;&#x5DE5;&#x4F5C;.</p>
<pre><code class="lang-scala">    <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">ConsumerConnector</span> </span>{
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createMessageStreams</span></span>(topicCountMap: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">Int</span>]): <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[<span class="hljs-type">Array</span>[<span class="hljs-type">Byte</span>],<span class="hljs-type">Array</span>[<span class="hljs-type">Byte</span>]]]]
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createMessageStreams</span></span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>](topicCountMap: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">Int</span>], keyDecoder: <span class="hljs-type">Decoder</span>[<span class="hljs-type">K</span>], valueDecoder: <span class="hljs-type">Decoder</span>[<span class="hljs-type">V</span>]) : <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>]]]
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createMessageStreamsByFilter</span></span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>](topicFilter: <span class="hljs-type">TopicFilter</span>, numStreams: <span class="hljs-type">Int</span> = <span class="hljs-number">1</span>, keyDecoder: <span class="hljs-type">Decoder</span>[<span class="hljs-type">K</span>] = <span class="hljs-keyword">new</span> <span class="hljs-type">DefaultDecoder</span>(), valueDecoder: <span class="hljs-type">Decoder</span>[<span class="hljs-type">V</span>] = <span class="hljs-keyword">new</span> <span class="hljs-type">DefaultDecoder</span>()) : <span class="hljs-type">Seq</span>[<span class="hljs-type">KafkaStream</span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>]]
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">commitOffsets</span></span>(retryOnFailure: <span class="hljs-type">Boolean</span>)
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">commitOffsets</span></span>(offsetsToCommit: immutable.<span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">OffsetAndMetadata</span>], retryOnFailure: <span class="hljs-type">Boolean</span>)
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setConsumerRebalanceListener</span></span>(listener: <span class="hljs-type">ConsumerRebalanceListener</span>)
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shutdown</span></span>()
    }
</code></pre>
<h2 id="zookeeperconsumerconnector">ZookeeperConsumerConnector</h2>
<p>&#x4E00;&#x4E2A;Consumer&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; ZookeeperConsumerConnector,&#x4EE3;&#x8868;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x8FDB;&#x7A0B;.</p>
<ul>
<li>fetcher: &#x6D88;&#x8D39;&#x8005;&#x83B7;&#x53D6;&#x6570;&#x636E;, &#x4F7F;&#x7528;ConsumerFetcherManager fetcher&#x7EBF;&#x7A0B;&#x6293;&#x53D6;&#x6570;&#x636E;</li>
<li>zkUtils: &#x6D88;&#x8D39;&#x8005;&#x8981;&#x548C;ZK&#x901A;&#x4FE1;, &#x9664;&#x4E86;&#x6CE8;&#x518C;&#x81EA;&#x5DF1;,&#x8FD8;&#x6709;&#x5176;&#x4ED6;&#x4FE1;&#x606F;&#x4E5F;&#x4F1A;&#x5199;&#x5230;ZK&#x4E2D;</li>
<li>topicThreadIdAndQueues: &#x6D88;&#x8D39;&#x8005;&#x4F1A;&#x6307;&#x5B9A;&#x81EA;&#x5DF1;&#x6D88;&#x8D39;&#x54EA;&#x4E9B;topic,&#x5E76;&#x6307;&#x5B9A;&#x7EBF;&#x7A0B;&#x6570;, &#x6240;&#x4EE5;topicThreadId&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x961F;&#x5217;</li>
<li>messageStreamCreated: &#x6D88;&#x8D39;&#x8005;&#x4F1A;&#x521B;&#x5EFA;&#x6D88;&#x606F;&#x6D41;, &#x6BCF;&#x4E2A;&#x961F;&#x5217;&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x6D41;</li>
<li>offsetsChannel: offset&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x5728; ZK&#x6216;&#x8005; kafka&#x4E2D;,&#x5982;&#x679C;&#x5B58;&#x5728;kafka&#x91CC;,&#x50CF;&#x5176;&#x4ED6;&#x8BF7;&#x6C42;&#x4E00;&#x6837;,&#x9700;&#x8981;&#x548C;Broker&#x901A;&#x4FE1;</li>
<li>&#x8FD8;&#x6709;&#x5176;&#x4ED6;&#x51E0;&#x4E2A;Listener&#x76D1;&#x542C;&#x5668;,&#x5206;&#x522B;&#x7528;&#x4E8E;topicPartition&#x7684;&#x66F4;&#x65B0;,&#x8D1F;&#x8F7D;&#x5747;&#x8861;,&#x6D88;&#x8D39;&#x8005;&#x91CD;&#x65B0;&#x8D1F;&#x8F7D;&#x7B49;</li>
</ul>
<pre><code class="lang-scala"><span class="hljs-keyword">private</span>[kafka] <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZookeeperConsumerConnector</span>(<span class="hljs-params">val config: <span class="hljs-type">ConsumerConfig</span>, val enableFetcher: <span class="hljs-type">Boolean</span></span>) </span>
        <span class="hljs-keyword">extends</span> <span class="hljs-type">ConsumerConnector</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Logging</span> <span class="hljs-keyword">with</span> <span class="hljs-type">KafkaMetricsGroup</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> fetcher: <span class="hljs-type">Option</span>[<span class="hljs-type">ConsumerFetcherManager</span>] = <span class="hljs-type">None</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> zkUtils: <span class="hljs-type">ZkUtils</span> = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> topicRegistry = <span class="hljs-keyword">new</span> <span class="hljs-type">Pool</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Pool</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">PartitionTopicInfo</span>]]
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> checkpointedZkOffsets = <span class="hljs-keyword">new</span> <span class="hljs-type">Pool</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">Long</span>]
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> topicThreadIdAndQueues = <span class="hljs-keyword">new</span> <span class="hljs-type">Pool</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">ConsumerThreadId</span>), <span class="hljs-type">BlockingQueue</span>[<span class="hljs-type">FetchedDataChunk</span>]]
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> scheduler = <span class="hljs-keyword">new</span> <span class="hljs-type">KafkaScheduler</span>(threads = <span class="hljs-number">1</span>, threadNamePrefix = <span class="hljs-string">&quot;kafka-consumer-scheduler-&quot;</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> messageStreamCreated = <span class="hljs-keyword">new</span> <span class="hljs-type">AtomicBoolean</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> offsetsChannel: <span class="hljs-type">BlockingChannel</span> = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> sessionExpirationListener: <span class="hljs-type">ZKSessionExpireListener</span> = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> topicPartitionChangeListener: <span class="hljs-type">ZKTopicPartitionChangeListener</span> = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> loadBalancerListener: <span class="hljs-type">ZKRebalancerListener</span> = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> wildcardTopicWatcher: <span class="hljs-type">ZookeeperTopicEventWatcher</span> = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> consumerRebalanceListener: <span class="hljs-type">ConsumerRebalanceListener</span> = <span class="hljs-literal">null</span>

  connectZk()                       <span class="hljs-comment">// &#x2460; &#x521B;&#x5EFA;ZkUtils,&#x4F1A;&#x521B;&#x5EFA;&#x5BF9;&#x5E94;&#x7684;ZkConnection&#x548C;ZkClient</span>
  createFetcher()                   <span class="hljs-comment">// &#x2461; &#x521B;&#x5EFA;ConsumerFetcherManager,&#x6D88;&#x8D39;&#x8005;fetcher&#x7EBF;&#x7A0B;</span>
  ensureOffsetManagerConnected()    <span class="hljs-comment">// &#x2462; &#x786E;&#x4FDD;&#x8FDE;&#x63A5;&#x4E0A;OffsetManager.</span>
  <span class="hljs-keyword">if</span> (config.autoCommitEnable) {    <span class="hljs-comment">// &#x2463; &#x542F;&#x52A8;&#x5B9A;&#x65F6;&#x63D0;&#x4EA4;offset&#x7EBF;&#x7A0B;</span>
    scheduler.startup              
    scheduler.schedule(<span class="hljs-string">&quot;kafka-consumer-autocommit&quot;</span>, autoCommit, delay = config.autoCommitIntervalMs, period = config.autoCommitIntervalMs, unit = <span class="hljs-type">TimeUnit</span>.<span class="hljs-type">MILLISECONDS</span>)
  }
}
</code></pre>
<h2 id="zk-and-broker">zk and broker</h2>
<ul>
<li>&#x2460; /brokers -&gt;&gt; topics&#x548C; ids: &#x96C6;&#x7FA4;&#x4E2D;&#x6240;&#x6709;&#x7684;topics,&#x4EE5;&#x53CA;&#x6240;&#x6709;&#x7684;brokers.</li>
<li>&#x2461; /brokers/ids/broker_id -&gt; &#x4E3B;&#x673A;&#x7684;&#x57FA;&#x672C;&#x4FE1;&#x606F;,&#x5305;&#x62EC;&#x4E3B;&#x673A;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x53F7;</li>
</ul>
<pre><code class="lang-?">[zk: 192.168.47.83:2181,192.168.47.84:2181,192.168.47.86:2181(CONNECTED) 1] ls /brokers
[topics, ids]

[zk: 192.168.47.83:2181,192.168.47.84:2181,192.168.47.86:2181(CONNECTED) 2] ls /brokers/ids
[3, 5, 4]
[zk: 192.168.47.83:2181,192.168.47.84:2181,192.168.47.86:2181(CONNECTED) 4] get /brokers/ids/3
{&quot;jmx_port&quot;:10055,&quot;timestamp&quot;:&quot;1453380999577&quot;,&quot;host&quot;:&quot;192.168.48.153&quot;,&quot;version&quot;:1,&quot;port&quot;:9092}
</code></pre>
<ul>
<li>&#x2462; /brokers/topics/topic_name -&gt; topic&#x7684;&#x6BCF;&#x4E2A; partition,&#x4EE5;&#x53CA;&#x5206;&#x914D;&#x7684;replicas(AR)</li>
<li>&#x2463; /brokers/topics/topic_name/partitions/partition_id/state -&gt; &#x8FD9;&#x4E2A;partition&#x7684; leader,isr</li>
</ul>
<pre><code class="lang-?">[zk: 192.168.47.83:2181,192.168.47.84:2181,192.168.47.86:2181(CONNECTED) 17] get /brokers/topics/topic1
{&quot;version&quot;:1,&quot;partitions&quot;:{&quot;2&quot;:[5,4],&quot;1&quot;:[4,3],&quot;0&quot;:[3,5]}}   &#x2B05;&#xFE0F;

[zk: 192.168.47.83:2181,192.168.47.84:2181,192.168.47.86:2181(CONNECTED) 12] ls /brokers/topics/topic1/partitions
[2, 1, 0]
[zk: 192.168.47.83:2181,192.168.47.84:2181,192.168.47.86:2181(CONNECTED) 13] ls /brokers/topics/topic1/partitions/0
[state]
[zk: 192.168.47.83:2181,192.168.47.84:2181,192.168.47.86:2181(CONNECTED) 15] get /brokers/topics/topic1/partitions/0/state
{&quot;controller_epoch&quot;:1775,&quot;leader&quot;:3,&quot;version&quot;:1,&quot;leader_epoch&quot;:145,&quot;isr&quot;:[3,5]}
</code></pre>
<p><img src="20160126150532822" alt=""></p>
<blockquote>
<p>&#x4E0A;&#x56FE;&#x662F;kafka manager&#x4E2D;&#x67D0;&#x4E2A; topic&#x7684; PartitionInfo, &#x96C6;&#x7FA4;&#x53EA;&#x6709;3&#x4E2A;&#x8282;&#x70B9;,&#x8FD9;&#x4E2A;topic&#x6709;3&#x4E2A;partition,2&#x4E2A;&#x526F;&#x672C;.</p>
</blockquote>
<h3 id="&#x2461;-broker-node-registry">&#x2461; Broker node registry</h3>
<p><code>/brokers/ids/0 --&gt; { &quot;host&quot; : &quot;host:port&quot;, &quot;topics&quot; : {&quot;topic1&quot;: [&quot;partition1&quot; ... &quot;partitionN&quot;], ..., &quot;topicN&quot;: [&quot;partition1&quot; ... &quot;partitionN&quot;] } }</code></p>
<p>&#x6BCF;&#x4E2A;Broker&#x8282;&#x70B9;&#x5728;&#x81EA;&#x5DF1;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;,&#x4F1A;&#x5728;/brokers&#x4E0B;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x903B;&#x8F91;&#x8282;&#x70B9;. &#x5185;&#x5BB9;&#x5305;&#x62EC;&#x4E86;Broker&#x7684;&#x4E3B;&#x673A;&#x548C;&#x7AEF;&#x53E3;, Broker&#x670D;&#x52A1;&#x7684;&#x6240;&#x6709; topic,
&#x4EE5;&#x53CA;&#x5206;&#x914D;&#x5230;&#x5F53;&#x524D;Broker&#x7684;&#x8FD9;&#x4E2A; topic&#x7684; partition&#x5217;&#x8868;(&#x5E76;&#x4E0D;&#x662F;topic&#x7684;&#x5168;&#x90E8; partition,&#x4F1A;&#x5C06;&#x6240;&#x6709;partition&#x5206;&#x5E03;&#x5728;&#x4E0D;&#x540C;&#x7684; brokers).</p>
<blockquote>
<p>A consumer subscribes to event changes of the broker node registry.
&#x5F53;Broker&#x6302;&#x6389;&#x7684;&#x65F6;&#x5019;,&#x5728;&#x8FD9;&#x4E2A;Broker&#x4E0A;&#x7684;&#x6240;&#x6709; Partition&#x90FD;&#x4E22;&#x5931;&#x4E86;,&#x800C;Partition&#x662F;&#x7ED9;&#x6D88;&#x8D39;&#x8005;&#x670D;&#x52A1;&#x7684;.
&#x6240;&#x4EE5;Broker&#x6302;&#x6389;&#x540E;&#x5728;&#x505A;&#x8FC1;&#x79FB;&#x7684;&#x65F6;&#x5019;,&#x4F1A;&#x5C06;&#x5176;&#x4E0A;&#x7684;Partition&#x8F6C;&#x79FB;&#x5230;&#x5176;&#x4ED6; Broker&#x4E0A;,&#x56E0;&#x6B64;&#x6D88;&#x8D39;&#x8005;&#x8981;&#x6D88;&#x8D39;&#x7684;Partition&#x4E5F;&#x8DDF;&#x7740;&#x53D8;&#x5316;.</p>
</blockquote>
<h3 id="&#x2462;-broker-topic-registry">&#x2462; Broker topic registry</h3>
<p><code>/brokers/topics/topic1 -&gt; {&quot;version&quot;:1,&quot;partitions&quot;:{&quot;2&quot;:[5,4],&quot;1&quot;:[4,3],&quot;0&quot;:[3,5]}}</code></p>
<p>&#x867D;&#x7136;topic&#x662F;&#x5728;/brokers&#x4E0B;,&#x4F46;&#x662F;&#x8FD9;&#x4E2A;topic&#x7684;&#x4FE1;&#x606F;&#x662F;&#x5168;&#x5C40;&#x7684;.&#x5728;&#x521B;&#x5EFA;topic&#x7684;&#x65F6;&#x5019;,&#x8FD9;&#x4E2A;topic&#x7684;&#x6BCF;&#x4E2A; partition&#x7684;&#x7F16;&#x53F7;&#x4EE5;&#x53CA; replicas.
&#x5177;&#x4F53;&#x6BCF;&#x4E2A;partition&#x7684; Leader&#x4EE5;&#x53CA; isr&#x4FE1;&#x606F;&#x5219;&#x662F;&#x5728;/brokers/topics/topic_name/partitions/partition_id/state</p>
<h2 id="zk-and-consumer">zk and consumer</h2>
<p><strong>Consumer id registry</strong>: /consumers/[group_id]/ids/[consumer_id] -&gt; topic1,...topicN</p>
<p>&#x6BCF;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x4F1A;&#x5C06;&#x5B83;&#x7684;id&#x6CE8;&#x518C;&#x4E3A;&#x4E34;&#x65F6; znode&#x5E76;&#x4E14;&#x5C06;&#x5B83;&#x6240;&#x6D88;&#x8D39;&#x7684; topic&#x8BBE;&#x7F6E;&#x4E3A; znode&#x7684;&#x503C;,&#x5F53;&#x5BA2;&#x6237;&#x7AEF;(&#x6D88;&#x8D39;&#x8005;)&#x9000;&#x51FA;&#x65F6;,znode(consumer_id)&#x4F1A;&#x88AB;&#x5220;&#x9664;.</p>
<blockquote>
<p>A consumer subscribes to event changes of the consumer id registry within its group.
&#x6BCF;&#x4E2A;consumer&#x4F1A;&#x8BA2;&#x9605;&#x5B83;&#x6240;&#x5728;&#x7684;&#x6D88;&#x8D39;&#x7EC4;&#x4E2D;&#x5173;&#x4E8E; consumer_id&#x6CE8;&#x518C;&#x7684;&#x66F4;&#x65B0;&#x4E8B;&#x4EF6;. &#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6CE8;&#x518C;&#x5462;,&#x56E0;&#x4E3A;Kafka&#x53EA;&#x4F1A;&#x5C06;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x5230;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x7EC4;&#x4E2D;&#x552F;&#x4E00;&#x7684;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;.
&#x5982;&#x679C;&#x67D0;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x6302;&#x4E86;,&#x5B83;&#x8981;&#x628A;&#x672C;&#x6765;&#x53D1;&#x7ED9;&#x6302;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x7684;&#x6D88;&#x8D39;&#x8F6C;&#x7ED9;&#x8FD9;&#x4E2A;&#x6D88;&#x8D39;&#x7EC4;&#x4E2D;&#x5176;&#x4ED6;&#x7684;&#x6D88;&#x8D39;&#x8005;.&#x540C;&#x7406;,&#x6709;&#x65B0;&#x6D88;&#x8D39;&#x8005;&#x52A0;&#x5165;&#x6D88;&#x8D39;&#x7EC4;&#x65F6;,&#x4E5F;&#x4F1A;&#x8FDB;&#x884C;&#x8D1F;&#x8F7D;&#x5747;&#x8861;.</p>
</blockquote>
<p><strong>Partition owner registry</strong>: /consumers/[group_id]/owner/[topic]/[broker_id-partition_id] --&gt; consumer_node_id</p>
<p>&#x5728;&#x6D88;&#x8D39;&#x65F6;,&#x6BCF;&#x4E2A;topic&#x7684; partition&#x53EA;&#x80FD;&#x88AB;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7EC4;&#x4E2D;&#x7684;&#x552F;&#x4E00;&#x7684;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;.&#x5728;&#x6BCF;&#x6B21;&#x91CD;&#x65B0;&#x8D1F;&#x8F7D;&#x7684;&#x65F6;&#x5019;,&#x8FD9;&#x4E2A;&#x6620;&#x5C04;&#x7B56;&#x7565;&#x5C31;&#x4F1A;&#x91CD;&#x65B0;&#x6784;&#x5EFA;.</p>
<p><strong>Consumer offset tracking</strong>: /consumers/[group_id]/offsets/[topic]/[broker_id-partition_id] --&gt; offset_counter_value</p>
<p>&#x6BCF;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x90FD;&#x8981;&#x8DDF;&#x8E2A;&#x81EA;&#x5DF1;&#x6D88;&#x8D39;&#x7684;&#x6BCF;&#x4E2A; Partition&#x6700;&#x8FD1;&#x7684; offset.&#x8868;&#x793A;&#x81EA;&#x5DF1;&#x8BFB;&#x53D6;&#x5230;Partition&#x7684;&#x6700;&#x65B0;&#x4F4D;&#x7F6E;.
&#x7531;&#x4E8E;&#x4E00;&#x4E2A;Partition&#x53EA;&#x80FD;&#x88AB;&#x6D88;&#x8D39;&#x7EC4;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;,&#x6240;&#x4EE5;offset&#x662F;&#x4EE5;&#x6D88;&#x8D39;&#x7EC4;&#x4E3A;&#x7EA7;&#x522B;&#x7684;,&#x800C;&#x4E0D;&#x662F;&#x6D88;&#x8D39;&#x8005;.
&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x539F;&#x6765;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x6302;&#x4E86;&#x540E;,&#x5E94;&#x5F53;&#x5C06;&#x8FD9;&#x4E2A;Partition&#x4EA4;&#x7ED9;&#x540C;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x7EC4;&#x4E2D;&#x522B;&#x7684;&#x6D88;&#x8D39;&#x8005;,&#x800C;&#x6B64;&#x65F6;offset&#x662F;&#x6CA1;&#x6709;&#x53D8;&#x5316;&#x7684;.
&#x4E00;&#x4E2A;partition&#x53EF;&#x4EE5;&#x88AB;&#x4E0D;&#x540C;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x7EC4;&#x4E2D;&#x7684;&#x4E0D;&#x540C;&#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x540C;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x7EC4;&#x5FC5;&#x987B;&#x7EF4;&#x62A4;&#x4ED6;&#x4EEC;&#x5404;&#x81EA;&#x5BF9;&#x8BE5;partition&#x6D88;&#x8D39;&#x7684;&#x6700;&#x65B0;&#x7684; offset</p>
<h2 id="init">init</h2>
<p>&#x5728;&#x521B;&#x5EFA;ZookeeperConsumerConnector&#x65F6;,&#x6709;&#x51E0;&#x4E2A;&#x521D;&#x59CB;&#x5316;&#x65B9;&#x6CD5;&#x9700;&#x8981;&#x4E8B;&#x5148;&#x6267;&#x884C;.</p>
<ul>
<li>&#x56E0;&#x4E3A;&#x6D88;&#x8D39;&#x8005;&#x8981;&#x548C;ZK&#x901A;&#x4FE1;,&#x6240;&#x4EE5;connectZk&#x4F1A;&#x786E;&#x4FDD;&#x8FDE;&#x63A5;&#x4E0A; ZooKeeper</li>
<li>&#x6D88;&#x8D39;&#x8005;&#x8981;&#x6D88;&#x8D39;&#x6570;&#x636E;,&#x9700;&#x8981;&#x6709;&#x6293;&#x53D6;&#x7EBF;&#x7A0B;,&#x6240;&#x6709;&#x7684;&#x6293;&#x53D6;&#x7EBF;&#x7A0B;&#x4EA4;&#x7ED9;ConsumerFetcherManager&#x7EDF;&#x4E00;&#x7BA1;&#x7406;</li>
<li>&#x7531;&#x6D88;&#x8D39;&#x8005;&#x5BA2;&#x6237;&#x7AEF;&#x81EA;&#x5DF1;&#x4FDD;&#x5B58;offset,&#x800C;&#x6D88;&#x8D39;&#x8005;&#x4F1A;&#x6D88;&#x8D39;&#x591A;&#x4E2A;topic&#x7684;&#x591A;&#x4E2A; partition.</li>
<li>&#x7C7B;&#x4F3C;&#x591A;&#x4E2A;&#x6570;&#x636E;&#x6293;&#x53D6;&#x7EBF;&#x7A0B;&#x6709;&#x7BA1;&#x7406;&#x7C7B;,&#x591A;&#x4E2A;partition&#x7684; offset&#x7BA1;&#x7406;&#x7C7B; OffsetManager&#x662F;&#x4E00;&#x4E2A; GroupCoordinator</li>
<li>&#x5B9A;&#x65F6;&#x63D0;&#x4EA4;&#x7EBF;&#x7A0B;&#x4F1A;&#x4F7F;&#x7528;OffsetManager&#x5EFA;&#x7ACB;&#x7684;&#x901A;&#x9053;&#x5B9A;&#x65F6;&#x63D0;&#x4EA4; offset&#x5230; zk&#x6216;&#x8005; kafka.</li>
</ul>
<p><img src="20160125104919159" alt=""></p>
<h2 id="abstractfetchermanager">AbstractFetcherManager</h2>
<p>&#x6BCF;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x90FD;&#x6709;&#x81EA;&#x5DF1;&#x7684;ConsumerFetcherManager.fetch&#x52A8;&#x4F5C;&#x4E0D;&#x4EC5;&#x53EA;&#x6709;&#x6D88;&#x8D39;&#x8005;&#x6709;,Partition&#x7684;&#x526F;&#x672C;&#x4E5F;&#x4F1A;&#x62C9;&#x53D6; Leader&#x7684;&#x6570;&#x636E;.
createFetcherThread&#x62BD;&#x8C61;&#x65B9;&#x6CD5;&#x5BF9;&#x4E8E; Consumer&#x548C; Replica&#x4F1A;&#x5206;&#x522B;&#x521B;&#x5EFA; ConsumerFetcherThread&#x548C; ReplicaFetcherThread.</p>
<p><img src="20160125104937050" alt=""></p>
<p>&#x7531;&#x4E8E;&#x6D88;&#x8D39;&#x8005;&#x53EF;&#x4EE5;&#x6D88;&#x8D39;&#x591A;&#x4E2A;topic&#x7684;&#x591A;&#x4E2A; partition.&#x6BCF;&#x4E2A;TopicPartition&#x7EC4;&#x5408;&#x90FD;&#x4F1A;&#x6709;&#x4E00;&#x4E2A; fetcherId.
&#x6240;&#x4EE5;fetcherThreadMap&#x7684; key&#x5B9E;&#x9645;&#x4E0A;&#x5728;&#x7531;(broker_id, topic_id, partition_id)&#x7EC4;&#x6210;&#x7684;.
&#x9488;&#x5BF9;&#x6BCF;&#x4E2A;source broker&#x7684;&#x6BCF;&#x4E2A; partition&#x90FD;&#x4F1A;&#x6709;&#x62C9;&#x53D6;&#x7EBF;&#x7A0B;,&#x5373;&#x62C9;&#x53D6;&#x662F;&#x9488;&#x5BF9;partition&#x7EA7;&#x522B;&#x62C9;&#x53D6;&#x6570;&#x636E;&#x7684;.</p>
<pre><code class="lang-scala">    <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractFetcherManager</span>(<span class="hljs-params">protected val name: <span class="hljs-type">String</span>, clientId: <span class="hljs-type">String</span>, numFetchers: <span class="hljs-type">Int</span> = 1</span>) </span>{
        <span class="hljs-comment">// map of (source broker_id, fetcher_id per source broker) =&gt; fetcher</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> fetcherThreadMap = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">BrokerAndFetcherId</span>, <span class="hljs-type">AbstractFetcherThread</span>]
    }
    <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrokerAndFetcherId</span>(<span class="hljs-params">broker: <span class="hljs-type">BrokerEndPoint</span>, fetcherId: <span class="hljs-type">Int</span></span>)</span>
    <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrokerAndInitialOffset</span>(<span class="hljs-params">broker: <span class="hljs-type">BrokerEndPoint</span>, initOffset: <span class="hljs-type">Long</span></span>)</span>
</code></pre>
<p>&#x6240;&#x4EE5;BrokerAndFetcherId&#x53EF;&#x4EE5;&#x8868;&#x793A; Broker&#x4E0A;&#x67D0;&#x4E2A; topic&#x7684; PartitionId, &#x800C;BrokerAndInitialOffset&#x53EA;&#x662F; Broker&#x7EA7;&#x522B;&#x7684; offset.
addFetcherForPartitions&#x7684;&#x53C2;&#x6570;&#x4E2D; BrokerAndInitialOffset&#x662F;&#x548C; TopicAndPartition&#x6709;&#x5173;&#x7684;,&#x5373;Partition&#x7684; offset.
&#x4E3A;Partition&#x6DFB;&#x52A0; Fetcher&#x662F;&#x4E3A; Partition&#x521B;&#x5EFA; Fetcher&#x7EBF;&#x7A0B;. &#x56E0;&#x4E3A;Fetcher&#x7EBF;&#x7A0B;&#x662F;&#x7528;&#x6765;&#x6293;&#x53D6; Partition&#x7684;&#x6D88;&#x606F;.</p>
<pre><code class="lang-scala">  <span class="hljs-comment">// to be defined in subclass to create a specific fetcher</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createFetcherThread</span></span>(fetcherId: <span class="hljs-type">Int</span>, sourceBroker: <span class="hljs-type">BrokerEndPoint</span>): <span class="hljs-type">AbstractFetcherThread</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">addFetcherForPartitions</span></span>(partitionAndOffsets: <span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">BrokerAndInitialOffset</span>]) {
      <span class="hljs-comment">// &#x6839;&#x636E;broker-topic-partition&#x5206;&#x7EC4;. &#x6240;&#x4EE5;&#x76F8;&#x540C;partition&#x7684;&#x53EA;&#x4F1A;&#x6709;&#x4E00;&#x4E2A; fetcher&#x7EBF;&#x7A0B;</span>
      <span class="hljs-keyword">val</span> partitionsPerFetcher = partitionAndOffsets.groupBy{ <span class="hljs-keyword">case</span>(topicAndPartition, brokerAndInitialOffset) =&gt;
        <span class="hljs-type">BrokerAndFetcherId</span>(brokerAndInitialOffset.broker, getFetcherId(topicAndPartition.topic, topicAndPartition.partition))}
      <span class="hljs-comment">// &#x5206;&#x7EC4;&#x4E4B;&#x540E;&#x7684;value&#x4ECD;&#x7136;&#x4E0D;&#x53D8;,&#x8FD8;&#x662F;partitionAndOffsets,&#x4F46;&#x662F;&#x76F8;&#x540C;&#x7684;partition&#x7684;&#x591A;&#x4E2A; partitionAndOffsets&#x90FD;&#x805A;&#x5408;&#x5728;&#x4E00;&#x8D77;&#x4E86; </span>
      <span class="hljs-keyword">for</span> ((brokerAndFetcherId, partitionAndOffsets) &lt;- partitionsPerFetcher) {
        <span class="hljs-comment">// &#x5728;&#x8FD9;&#x91CC;&#x60F3;&#x8981;&#x4E3A;&#x6BCF;&#x4E2A;fetcherId&#x521B;&#x5EFA;&#x62C9;&#x53D6;&#x7EBF;&#x7A0B;&#x7684;. &#x5982;&#x679C;&#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;,&#x5426;&#x5219;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x62C9;&#x53D6;&#x7EBF;&#x7A0B;</span>
        <span class="hljs-keyword">var</span> fetcherThread: <span class="hljs-type">AbstractFetcherThread</span> = <span class="hljs-literal">null</span>
        fetcherThreadMap.get(brokerAndFetcherId) <span class="hljs-keyword">match</span> {
          <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(f) =&gt; fetcherThread = f
          <span class="hljs-keyword">case</span> <span class="hljs-type">None</span> =&gt;
            fetcherThread = createFetcherThread(brokerAndFetcherId.fetcherId, brokerAndFetcherId.broker)
            fetcherThreadMap.put(brokerAndFetcherId, fetcherThread)
            fetcherThread.start         <span class="hljs-comment">// &#x542F;&#x52A8;&#x521A;&#x521A;&#x521B;&#x5EFA;&#x7684;&#x62C9;&#x53D6;&#x7EBF;&#x7A0B;</span>
        }

        <span class="hljs-comment">// &#x7531;&#x4E8E;partitionAndOffsets&#x73B0;&#x5728;&#x5DF2;&#x7ECF;&#x662F;&#x5728;&#x540C;&#x4E00;&#x4E2A; partition&#x91CC;. &#x53D6;&#x5F97;&#x6240;&#x6709;partition&#x5BF9;&#x5E94;&#x7684; offset</span>
        fetcherThreadMap(brokerAndFetcherId).addPartitions(partitionAndOffsets.map {
          <span class="hljs-keyword">case</span> (topicAndPartition, brokerAndInitOffset) =&gt; topicAndPartition -&gt; brokerAndInitOffset.initOffset
        })
      }
  }
</code></pre>
<p><img src="20160126084058247" alt=""></p>
<h2 id="abstractfetcherthread-addpartitions">AbstractFetcherThread addPartitions</h2>
<p>Consumer&#x548C; Replica&#x7684; FetcherManager&#x90FD;&#x4F1A;&#x8D1F;&#x8D23;&#x5C06;&#x81EA;&#x5DF1;&#x8981;&#x6293;&#x53D6;&#x7684; partitionAndOffsets&#x4F20;&#x7ED9;&#x5BF9;&#x5E94;&#x7684; Fetcher&#x7EBF;&#x7A0B;.</p>
<pre><code class="lang-?">AbstractFetcherManager.addFetcherForPartitions(Map&lt;TopicAndPartition, BrokerAndInitialOffset&gt;)  (kafka.server)
    |-- LeaderFinderThread in ConsumerFetcherManager.doWork()  (kafka.consumer)
    |-- ReplicaManager.makeFollowers(int, int, Map&lt;Partition, PartitionState&gt;, int, Map&lt;TopicPartition, Object&gt;, MetadataCache)  (kafka.server)
</code></pre>
<p>&#x6293;&#x53D6;&#x7EBF;&#x7A0B;&#x4E5F;&#x662F;&#x7528;partitionMap&#x7F13;&#x5B58;&#x6765;&#x4FDD;&#x5B58;&#x6BCF;&#x4E2A; TopicAndPartition&#x7684;&#x6293;&#x53D6;&#x72B6;&#x6001;.&#x5373;&#x7BA1;&#x7406;&#x8005;&#x8D1F;&#x8D23;&#x7EBF;&#x7A0B;&#x76F8;&#x5173;,&#x800C;&#x7EBF;&#x7A0B;&#x8D1F;&#x8D23;&#x72B6;&#x6001;&#x76F8;&#x5173;.
Partition&#x7684;&#x72B6;&#x6001;&#x5C31;&#x662F; offset&#x4FE1;&#x606F;.&#x4F46;&#x662F;&#x62C9;&#x53D6;&#x72B6;&#x6001;&#x5E76;&#x4E0D;&#x662F;&#x5B9E;&#x65F6;&#x66F4;&#x65B0;&#x7684;,PartitionFetchState&#x8FD8;&#x5305;&#x62EC;&#x4E86; isActive&#x8868;&#x793A;&#x662F;&#x5426;&#x5EF6;&#x8FDF;.
&#x5BF9;&#x4E00;&#x4E2A;Partition&#x5EF6;&#x8FDF;,&#x5224;&#x65AD;isActive&#x72B6;&#x6001;&#x540E;,&#x7528;&#x5EF6;&#x8FDF;&#x65F6;&#x95F4;&#x5C01;&#x88C5;&#x5230;DelayedItem. &#x4E00;&#x822C;&#x51FA;&#x9519;&#x7684;&#x62C9;&#x53D6;&#x4F1A;&#x88AB;&#x5EF6;&#x8FDF;back-off&#x6BEB;&#x79D2;.</p>
<pre><code class="lang-scala"><span class="hljs-comment">// Abstract class for fetching data from multiple partitions from the same broker.</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractFetcherThread</span>(<span class="hljs-params">name: <span class="hljs-type">String</span>, clientId: <span class="hljs-type">String</span>, sourceBroker: <span class="hljs-type">BrokerEndPoint</span>, fetchBackOffMs: <span class="hljs-type">Int</span> = 0, isInterruptible: <span class="hljs-type">Boolean</span> = true</span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">ShutdownableThread</span>(<span class="hljs-params">name, isInterruptible</span>) </span>{
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> partitionMap = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">PartitionFetchState</span>] <span class="hljs-comment">// a (topic, partition) -&gt; partitionFetchState map</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">addPartitions</span></span>(partitionAndOffsets: <span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">Long</span>]) {
    partitionMapLock.lockInterruptibly()
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">for</span> ((topicAndPartition, offset) &lt;- partitionAndOffsets) {
        <span class="hljs-comment">// If the partitionMap already has the topic/partition, then do not update the map with the old offset</span>
        <span class="hljs-keyword">if</span> (!partitionMap.contains(topicAndPartition))
          partitionMap.put(topicAndPartition,
            <span class="hljs-keyword">if</span> (<span class="hljs-type">PartitionTopicInfo</span>.isOffsetInvalid(offset)) <span class="hljs-keyword">new</span> <span class="hljs-type">PartitionFetchState</span>(handleOffsetOutOfRange(topicAndPartition))
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">new</span> <span class="hljs-type">PartitionFetchState</span>(offset)
          )}
      partitionMapCond.signalAll()
    } <span class="hljs-keyword">finally</span> partitionMapLock.unlock()
  }
</code></pre>
<h2 id="fetchrequest--partitiondata">FetchRequest &amp; PartitionData</h2>
<p>&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x6307;&#x5B9A;&#x8981;&#x62C9;&#x53D6;&#x54EA;&#x4E2A;TopicAndPartition(offset&#x6765;&#x81EA;&#x4E8E; PartitionFetchState), PartitionData&#x8FD4;&#x56DE;&#x8981;&#x62C9;&#x53D6;&#x7684;&#x6D88;&#x606F;&#x96C6;.</p>
<pre><code class="lang-scala">  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">REQ</span> <span class="hljs-title">&lt;</span></span>: <span class="hljs-type">FetchRequest</span>  <span class="hljs-comment">//&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x7684;&#x5B50;&#x7C7B;</span>
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">PD</span> <span class="hljs-title">&lt;</span></span>: <span class="hljs-type">PartitionData</span>  <span class="hljs-comment">//Partition&#x6570;&#x636E;,&#x5373;&#x62C9;&#x53D6;&#x7ED3;&#x679C;</span>

  <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">FetchRequest</span> </span>{      <span class="hljs-comment">//&#x5B9A;&#x4E49;&#x4E86;&#x62C9;&#x53D6;&#x63A5;&#x53E3;</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isEmpty</span></span>: <span class="hljs-type">Boolean</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">offset</span></span>(topicAndPartition: <span class="hljs-type">TopicAndPartition</span>): <span class="hljs-type">Long</span>
  }
  <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">PartitionData</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">errorCode</span></span>: <span class="hljs-type">Short</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exception</span></span>: <span class="hljs-type">Option</span>[<span class="hljs-type">Throwable</span>]
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">toByteBufferMessageSet</span></span>: <span class="hljs-type">ByteBufferMessageSet</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">highWatermark</span></span>: <span class="hljs-type">Long</span>
  }
<span class="hljs-type">FetchRequest</span>&#x548C;<span class="hljs-type">PartitionData</span>&#x4E5F;&#x6709;<span class="hljs-type">Consumer</span>&#x548C;<span class="hljs-type">Replica</span>&#x4E4B;&#x5206;. <span class="hljs-type">ConsumerFetcherThread</span>&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x4EA4;&#x7ED9;&#x4E86;underlying(&#x7C7B;&#x4F3C;&#x4E8E;&#x88C5;&#x9970;&#x6A21;&#x5F0F;).
<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">ConsumerFetcherThread</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FetchRequest</span>(<span class="hljs-params">val underlying: kafka.api.<span class="hljs-type">FetchRequest</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractFetcherThread</span>.<span class="hljs-title">FetchRequest</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isEmpty</span></span>: <span class="hljs-type">Boolean</span> = underlying.requestInfo.isEmpty
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">offset</span></span>(topicAndPartition: <span class="hljs-type">TopicAndPartition</span>): <span class="hljs-type">Long</span> = underlying.requestInfo(topicAndPartition).offset
  }
  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PartitionData</span>(<span class="hljs-params">val underlying: <span class="hljs-type">FetchResponsePartitionData</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractFetcherThread</span>.<span class="hljs-title">PartitionData</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">errorCode</span></span>: <span class="hljs-type">Short</span> = underlying.error
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">toByteBufferMessageSet</span></span>: <span class="hljs-type">ByteBufferMessageSet</span> = underlying.messages.asInstanceOf[<span class="hljs-type">ByteBufferMessageSet</span>]
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">highWatermark</span></span>: <span class="hljs-type">Long</span> = underlying.hw
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exception</span></span>: <span class="hljs-type">Option</span>[<span class="hljs-type">Throwable</span>] = <span class="hljs-keyword">if</span> (errorCode == <span class="hljs-type">ErrorMapping</span>.<span class="hljs-type">NoError</span>) <span class="hljs-type">None</span> <span class="hljs-keyword">else</span> <span class="hljs-type">Some</span>(<span class="hljs-type">ErrorMapping</span>.exceptionFor(errorCode))
  }
}
</code></pre>
<p>&#x6765;&#x81EA;&#x4E8E;kafka.api&#x7684; FetchRequest&#x624D;&#x662F;&#x771F;&#x6B63;&#x9762;&#x5411; KafkaApis&#x7684;&#x8BF7;&#x6C42;.PartitionFetchInfo&#x9664;&#x4E86; offset&#x8FD8;&#x6709; fetchSize.
RequestOrResponse&#x662F;&#x4F5C;&#x4E3A; KafkaApis&#x4E2D;&#x6570;&#x636E;&#x4F20;&#x9012;&#x7684;&#x4ECB;&#x8D28;&#x63A5;&#x53E3;. &#x53C2;&#x6570;requestId&#x8868;&#x793A;&#x4E86;&#x8BF7;&#x6C42;&#x7684;&#x7C7B;&#x578B;(PRODUCE,FETCH&#x7B49;)</p>
<pre><code class="lang-scala"><span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PartitionFetchInfo</span>(<span class="hljs-params">offset: <span class="hljs-type">Long</span>, fetchSize: <span class="hljs-type">Int</span></span>)</span>

<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FetchRequest</span>(<span class="hljs-params">versionId: <span class="hljs-type">Short</span> = <span class="hljs-type">FetchRequest</span>.<span class="hljs-type">CurrentVersion</span>,correlationId: <span class="hljs-type">Int</span> = <span class="hljs-type">FetchRequest</span>.<span class="hljs-type">DefaultCorrelationId</span>,
                        clientId: <span class="hljs-type">String</span> = <span class="hljs-type">ConsumerConfig</span>.<span class="hljs-type">DefaultClientId</span>,replicaId: <span class="hljs-type">Int</span> = <span class="hljs-type">Request</span>.<span class="hljs-type">OrdinaryConsumerId</span>,
                        maxWait: <span class="hljs-type">Int</span> = <span class="hljs-type">FetchRequest</span>.<span class="hljs-type">DefaultMaxWait</span>,minBytes: <span class="hljs-type">Int</span> = <span class="hljs-type">FetchRequest</span>.<span class="hljs-type">DefaultMinBytes</span>,
                        requestInfo: <span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">PartitionFetchInfo</span>]</span>)</span>
        <span class="hljs-keyword">extends</span> <span class="hljs-type">RequestOrResponse</span>(<span class="hljs-type">Some</span>(<span class="hljs-type">ApiKeys</span>.<span class="hljs-type">FETCH</span>.id))
</code></pre>
<p><img src="20160126084038512" alt=""></p>
<h3 id="consumerfetcherthreadbuildfetchrequest">ConsumerFetcherThread.buildFetchRequest</h3>
<p>AbstractFetcherThread&#x7684; doWork&#x4F1A;&#x62BD;&#x8C61;&#x51FA; buildFetchRequest,ConsumerFetcherThread&#x4F1A;&#x4F7F;&#x7528; FetchRequestBuilder
build&#x51FA;&#x6765;&#x7684;&#x662F;&#x548C; kafka.api.FetchRequestBuilder&#x76F8;&#x540C;&#x6587;&#x4EF6;&#x4E0B;&#x7684; kafka.api.FetchRequest,&#x4F5C;&#x4E3A;underlying.</p>
<p>&#x6CE8;&#x610F;&#x5176;&#x4E2D;Partition&#x7684; offset&#x6700;&#x5F00;&#x59CB;&#x6E90;&#x81EA;&#x4E8E; AbstractFetcherManager.addFetcherForPartitions&#x7684; BrokerAndInitialOffset
&#x7136;&#x540E;&#x83B7;&#x53D6;brokerAndInitOffset.initOffset&#x4F5C;&#x4E3A; AbstractFetcherThread.addPartitions&#x65B9;&#x6CD5;&#x53C2;&#x6570; Map&#x7684; value, &#x5E76;&#x8F6C;&#x5316;&#x4E3A;PartitionFetchState&#x52A0;&#x5165;&#x5230; partitionMap&#x4E2D;,&#x5728; buildFetchRequest&#x53C8;&#x8F6C;&#x5316;&#x4E3A;&#x4E86; PartitionFetchInfo.</p>
<p>&#x6CE8;&#x610F;:&#x4E0A;&#x9762;&#x53EA;&#x662F;&#x4E00;&#x79CD;&#x6765;&#x6E90;,&#x62C9;&#x53D6;&#x7EBF;&#x7A0B;&#x5728;&#x62C9;&#x53D6;&#x6570;&#x636E;&#x4E4B;&#x540E;,&#x4F1A;&#x66F4;&#x65B0;&#x8FD9;&#x6279;&#x6570;&#x636E;&#x6700;&#x540E;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;offset&#x4F5C;&#x4E3A; <strong>partitionMap</strong>&#x4E2D; Partition&#x7684;&#x6700;&#x65B0; PartitionFetchState,&#x6240;&#x4EE5;&#x4E0B;&#x4E00;&#x6B21;&#x8C03;&#x7528;buildFetchRequest&#x6784;&#x5EFA;&#x65B0;&#x7684; FetchRequest&#x65F6;,PartitionFetchInfo&#x7684; offset&#x4E5F;&#x662F;&#x6700;&#x65B0;&#x7684;.</p>
<pre><code class="lang-scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerFetcherThread</span>(<span class="hljs-params">...</span>)</span>{
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> fetchRequestBuilder = <span class="hljs-keyword">new</span> <span class="hljs-type">FetchRequestBuilder</span>().
    clientId(clientId).replicaId(<span class="hljs-type">Request</span>.<span class="hljs-type">OrdinaryConsumerId</span>).maxWait(config.fetchWaitMaxMs).
    minBytes(config.fetchMinBytes).requestVersion(kafka.api.<span class="hljs-type">FetchRequest</span>.<span class="hljs-type">CurrentVersion</span>)

  <span class="hljs-comment">// partitionMap&#x6765;&#x81EA;&#x4E8E; AbstractFetcherThread.addPartitions&#x6216;&#x8005; delayPartitions</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">buildFetchRequest</span></span>(partitionMap: collection.<span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">PartitionFetchState</span>]): <span class="hljs-type">FetchRequest</span> = {
    partitionMap.foreach { <span class="hljs-keyword">case</span> ((topicAndPartition, partitionFetchState)) =&gt;
      <span class="hljs-keyword">if</span> (partitionFetchState.isActive)
        fetchRequestBuilder.addFetch(topicAndPartition.topic, topicAndPartition.partition, partitionFetchState.offset, fetchSize)
    }
    <span class="hljs-keyword">new</span> <span class="hljs-type">FetchRequest</span>(fetchRequestBuilder.build())  <span class="hljs-comment">//&#x6784;&#x9020;&#x5668;&#x6A21;&#x5F0F;,&#x5728;&#x6700;&#x540E;&#x624D;&#x8FDB;&#x884C;build</span>
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FetchRequestBuilder</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> requestMap = <span class="hljs-keyword">new</span> collection.mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">PartitionFetchInfo</span>]

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">addFetch</span></span>(topic: <span class="hljs-type">String</span>, partition: <span class="hljs-type">Int</span>, offset: <span class="hljs-type">Long</span>, fetchSize: <span class="hljs-type">Int</span>) = {
    requestMap.put(<span class="hljs-type">TopicAndPartition</span>(topic, partition), <span class="hljs-type">PartitionFetchInfo</span>(offset, fetchSize))
    <span class="hljs-keyword">this</span>
  }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">build</span></span>() = {
    <span class="hljs-keyword">val</span> fetchRequest = <span class="hljs-type">FetchRequest</span>(versionId, correlationId.getAndIncrement, clientId, replicaId, maxWait, minBytes, requestMap.toMap)
    requestMap.clear()
    fetchRequest
  }
}
</code></pre>
<h2 id="abstractfetcherthread-dowork">AbstractFetcherThread doWork</h2>
<p>AbstractFetcherThread&#x5B9A;&#x4E49;&#x4E86;&#x591A;&#x4E2A;&#x56DE;&#x8C03;&#x65B9;&#x6CD5;,&#x5B83;&#x7684;doWork&#x65B9;&#x6CD5;&#x4F1A;&#x6784;&#x5EFA; FetchRequest,&#x7136;&#x540E;&#x5904;&#x7406;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;.
&#x56E0;&#x4E3A;&#x62C9;&#x53D6;&#x5206;&#x4E3A;Consumer&#x548C; Replica,&#x6240;&#x4EE5;&#x5C06;&#x5177;&#x4F53;&#x7684;&#x62C9;&#x53D6;&#x52A8;&#x4F5C;&#x8981;&#x7559;&#x7ED9;&#x5B50;&#x7C7B;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;.</p>
<blockquote>
<p>&#x6CE8;&#x610F;:&#x4E0B;&#x9762;&#x7684;partitionMap&#x5728; addPartitions&#x4E2D;&#x88AB;&#x6DFB;&#x52A0;.&#x5728;doWork&#x62C9;&#x53D6;&#x5230;&#x6570;&#x636E;&#x540E;&#x88AB;&#x66F4;&#x65B0; offset,&#x8868;&#x793A;&#x6700;&#x65B0;&#x62C9;&#x53D6;&#x7684;&#x4F4D;&#x7F6E;</p>
</blockquote>
<p><img src="20160126084015605" alt=""></p>
<pre><code class="lang-scala">    <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractFetcherThread</span>(<span class="hljs-params">..</span>)</span>{
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> partitionMap = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">PartitionFetchState</span>] <span class="hljs-comment">// a (topic, partition) -&gt; partitionFetchState map</span>

        <span class="hljs-comment">// &#x2460; &#x6839;&#x636E;partitionMap&#x6784;&#x5EFA;FetchRequest&#x8BF7;&#x6C42;</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">buildFetchRequest</span></span>(partitionMap: <span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">PartitionFetchState</span>]): <span class="hljs-type">REQ</span>
        <span class="hljs-comment">// &#x2461; &#x6839;&#x636E;&#x6293;&#x53D6;&#x8BF7;&#x6C42;&#x5411;Broker&#x62C9;&#x53D6;&#x6D88;&#x606F;</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fetch</span></span>(fetchRequest: <span class="hljs-type">REQ</span>): <span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">PD</span>]
        <span class="hljs-comment">// &#x2462; process fetched data &#x5904;&#x7406;&#x6293;&#x53D6;&#x5230;&#x7684;&#x6570;&#x636E;</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processPartitionData</span></span>(topicAndPartition: <span class="hljs-type">TopicAndPartition</span>, fetchOffset: <span class="hljs-type">Long</span>, partitionData: <span class="hljs-type">PD</span>)
        <span class="hljs-comment">// &#x2463; handle a partition whose offset is out of range and return a new fetch offset &#x5904;&#x7406;&#x8D85;&#x51FA;&#x8303;&#x56F4;&#x7684;offset</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handleOffsetOutOfRange</span></span>(topicAndPartition: <span class="hljs-type">TopicAndPartition</span>): <span class="hljs-type">Long</span>
        <span class="hljs-comment">// &#x2464; deal with partitions with errors, potentially due to leadership changes &#x5904;&#x7406;&#x51FA;&#x9519;&#x7684;partitions</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handlePartitionsWithErrors</span></span>(partitions: <span class="hljs-type">Iterable</span>[<span class="hljs-type">TopicAndPartition</span>])

        <span class="hljs-comment">// &#x62C9;&#x53D6;&#x7EBF;&#x7A0B;&#x5DE5;&#x4F5C;, doWork&#x662F;&#x88AB;&#x5FAA;&#x73AF;&#x8C03;&#x7528;&#x7684;,&#x6240;&#x4EE5;&#x4E00;&#x65E6;partiionMap&#x53D1;&#x751F;&#x4E86;&#x53D8;&#x5316;(&#x6BD4;&#x5982;&#x62C9;&#x53D6;&#x4E00;&#x6B21;&#x4E4B;&#x540E;),&#x65B0;&#x7684;FetchRequest&#x4E2D;&#x7684;offset&#x4E5F;&#x53D1;&#x751F;&#x4E86;&#x53D8;&#x5316; </span>
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">doWork</span></span>() {
            <span class="hljs-keyword">val</span> fetchRequest = inLock(partitionMapLock) {
            <span class="hljs-keyword">val</span> fetchRequest = buildFetchRequest(partitionMap)
            <span class="hljs-comment">// &#x5982;&#x679C;&#x6CA1;&#x6709;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;, &#x5219;&#x5EF6;&#x8FDF;back-off&#x6BEB;&#x79D2;&#x540E;&#x7EE7;&#x7EED;&#x53D1;&#x9001;&#x8BF7;&#x6C42;</span>
            <span class="hljs-keyword">if</span> (fetchRequest.isEmpty) partitionMapCond.await(fetchBackOffMs, <span class="hljs-type">TimeUnit</span>.<span class="hljs-type">MILLISECONDS</span>)
            fetchRequest
            }
            <span class="hljs-keyword">if</span> (!fetchRequest.isEmpty) processFetchRequest(fetchRequest)
        }

        <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processFetchRequest</span></span>(fetchRequest: <span class="hljs-type">REQ</span>) {
            <span class="hljs-keyword">val</span> partitionsWithError = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashSet</span>[<span class="hljs-type">TopicAndPartition</span>]
            <span class="hljs-keyword">var</span> responseData: <span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">PD</span>] = <span class="hljs-type">Map</span>.empty
            responseData = fetch(fetchRequest)
            responseData.foreach { <span class="hljs-keyword">case</span> (topicAndPartition, partitionData) =&gt;
            <span class="hljs-comment">// &#x54CD;&#x5E94;&#x7ED3;&#x679C;:TopicAndPartition-&gt;PartitionData,&#x6839;&#x636E;TopicAndPartition,&#x5C31;&#x80FD;&#x4ECE;partitionMap&#x4E2D;&#x7684; PartitionFetchState</span>
            partitionMap.get(topicAndPartition).foreach(currentPartitionFetchState =&gt;
                <span class="hljs-comment">// we append to the log if the current offset is defined and it is the same as the offset requested during fetch</span>
                <span class="hljs-comment">// fetchRequest&#x662F;&#x7531; partitionMap&#x901A;&#x8FC7; buildFetchRequest&#x6784;&#x5EFA;&#x51FA;&#x6765;&#x7684;,&#x800C;currentPartitionFetchState&#x4E5F;&#x6765;&#x81EA;&#x4E8E; partitionMap</span>
                <span class="hljs-keyword">if</span> (fetchRequest.offset(topicAndPartition) == currentPartitionFetchState.offset) {
                <span class="hljs-type">Errors</span>.forCode(partitionData.errorCode) <span class="hljs-keyword">match</span> {
                    <span class="hljs-keyword">case</span> <span class="hljs-type">Errors</span>.<span class="hljs-type">NONE</span> =&gt;
                        <span class="hljs-comment">// responseData&#x7684; PartitionData,&#x5305;&#x542B;&#x4E86;&#x62C9;&#x53D6;&#x7684;&#x6D88;&#x606F;&#x5185;&#x5BB9;</span>
                        <span class="hljs-keyword">val</span> messages = partitionData.toByteBufferMessageSet
                        <span class="hljs-comment">// &#x6700;&#x540E;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x7684;offset+1,&#x4E3A;&#x65B0;&#x7684;offset,&#x5373;&#x4E0B;&#x4E00;&#x6B21;&#x8981;&#x62C9;&#x53D6;&#x7684; offset&#x7684;&#x5F00;&#x59CB;&#x4F4D;&#x7F6E;&#x4ECE; newOffset&#x5F00;&#x59CB;</span>
                        <span class="hljs-keyword">val</span> newOffset = messages.shallowIterator.toSeq.lastOption <span class="hljs-keyword">match</span> {  <span class="hljs-comment">//&#x6B63;&#x5E38;&#x7684;&#x8FED;&#x4EE3;&#x5668;&#x8FED;&#x4EE3;&#x4E4B;&#x540E;&#x6D88;&#x606F;&#x5C31;&#x6CA1;&#x6709;&#x4E86;,&#x4F7F;&#x7528;shallow&#x62F7;&#x8D1D;,&#x6D88;&#x606F;&#x4ECD;&#x7136;&#x5B58;&#x5728;</span>
                        <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(m: <span class="hljs-type">MessageAndOffset</span>) =&gt; m.nextOffset
                        <span class="hljs-keyword">case</span> <span class="hljs-type">None</span> =&gt; currentPartitionFetchState.offset
                        }
                        <span class="hljs-comment">// &#x66F4;&#x65B0;partitionMap&#x4E2D;&#x7684; Partition&#x62C9;&#x53D6;&#x72B6;&#x6001;, &#x8FD9;&#x6837;&#x4E0B;&#x6B21;&#x8BF7;&#x6C42;&#x65F6;,&#x56E0;&#x4E3A;partitionMap&#x5185;&#x5BB9;&#x66F4;&#x65B0;&#x4E86;,&#x91CD;&#x65B0;&#x6784;&#x9020;&#x7684;buildFetchRequest&#x7684; offset&#x4E5F;&#x53D8;&#x5316;&#x4E86;</span>
                        partitionMap.put(topicAndPartition, <span class="hljs-keyword">new</span> <span class="hljs-type">PartitionFetchState</span>(newOffset))
                        processPartitionData(topicAndPartition, currentPartitionFetchState.offset, partitionData)
                    <span class="hljs-keyword">case</span> <span class="hljs-type">Errors</span>.<span class="hljs-type">OFFSET_OUT_OF_RANGE</span> =&gt; partitionMap.put(topicAndPartition, <span class="hljs-keyword">new</span> <span class="hljs-type">PartitionFetchState</span>(handleOffsetOutOfRange(topicAndPartition)))
                    <span class="hljs-keyword">case</span> _ =&gt; <span class="hljs-keyword">if</span> (isRunning.get) partitionsWithError += topicAndPartition
                }
                })
            }
            <span class="hljs-keyword">if</span> (partitionsWithError.nonEmpty) {
            handlePartitionsWithErrors(partitionsWithError)
            }
        }
    }
</code></pre>
<p><img src="20160126084118702" alt=""></p>
<p>&#x57FA;&#x672C;&#x4E0A;&#x6211;&#x4EEC;&#x628A;&#x5173;&#x4E8E;Fetcher&#x7684; Manager&#x548C; Thread&#x7684;&#x62BD;&#x8C61;&#x7C7B;&#x90FD;&#x5206;&#x6790;&#x5B8C;&#x4E86;,&#x73B0;&#x5728;&#x770B;&#x770B;Consumer&#x662F;&#x5982;&#x4F55; Fetch&#x6D88;&#x606F;&#x7684;.</p>
<h2 id="createmessagestreams">createMessageStreams</h2>
<p>&#x7531;ConsumerConnector&#x521B;&#x5EFA;&#x6D88;&#x606F;&#x6D41;,&#x9700;&#x8981;&#x6307;&#x5B9A;&#x89E3;&#x7801;&#x5668;,&#x56E0;&#x4E3A;&#x8981;&#x5C06;&#x65E5;&#x5FD7;&#x53CD;&#x5E8F;&#x5217;&#x5316;(&#x751F;&#x4EA7;&#x8005;&#x5199;&#x6D88;&#x606F;&#x65F6;&#x5BF9;&#x6D88;&#x606F;&#x5E8F;&#x5217;&#x5316;&#x5230;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;).
consume&#x5E76;&#x4E0D;&#x771F;&#x6B63;&#x7684;&#x6D88;&#x8D39;&#x6570;&#x636E;,&#x53EA;&#x662F;&#x521D;&#x59CB;&#x5316;&#x5B58;&#x653E;&#x6570;&#x636E;&#x7684;queue.&#x771F;&#x6B63;&#x6D88;&#x8D39;&#x6570;&#x636E;&#x7684;&#x662F;&#x5BF9;&#x8BE5; queue&#x8FDB;&#x884C; shallow iterator.
&#x5728;kafka&#x7684;&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;,&#x4F1A;&#x6709;&#x5176;&#x4ED6;&#x7684;&#x7EBF;&#x7A0B;&#x5C06;&#x6570;&#x636E;&#x653E;&#x5165; partition&#x5BF9;&#x5E94;&#x7684; queue&#x4E2D;. &#x800C;queue&#x662F;&#x7528;&#x4E8E; KafkaStream&#x7684;.
&#x4E00;&#x65E6;&#x6570;&#x636E;&#x6DFB;&#x52A0;&#x5230;queue&#x540E;,KafkaStream&#x7684;&#x963B;&#x585E;&#x961F;&#x5217;&#x5C31;&#x6709;&#x6570;&#x636E;&#x4E86;,&#x6D88;&#x8D39;&#x8005;&#x5C31;&#x53EF;&#x4EE5;&#x4ECE;&#x961F;&#x5217;&#x4E2D;&#x6D88;&#x8D39;&#x6D88;&#x606F;.</p>
<pre><code class="lang-scala">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createMessageStreams</span></span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>](topicCountMap: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">Int</span>], keyDecoder: <span class="hljs-type">Decoder</span>[<span class="hljs-type">K</span>], valueDecoder: <span class="hljs-type">Decoder</span>[<span class="hljs-type">V</span>]) : <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>]]] = {
    consume(topicCountMap, keyDecoder, valueDecoder)
  }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">consume</span></span>[<span class="hljs-type">K</span>, <span class="hljs-type">V</span>](topicCountMap: scala.collection.<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">Int</span>], keyDecoder: <span class="hljs-type">Decoder</span>[<span class="hljs-type">K</span>], valueDecoder: <span class="hljs-type">Decoder</span>[<span class="hljs-type">V</span>]) : <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>]]] = {
    <span class="hljs-keyword">val</span> topicCount = <span class="hljs-type">TopicCount</span>.constructTopicCount(consumerIdString, topicCountMap)
    <span class="hljs-keyword">val</span> topicThreadIds = topicCount.getConsumerThreadIdsPerTopic

    <span class="hljs-comment">// make a list of (queue,stream) pairs, one pair for each threadId &#x53EA;&#x662F;&#x51C6;&#x5907;&#x4E86;&#x961F;&#x5217;&#x548C;&#x6D41;,&#x6570;&#x636E;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x586B;&#x5145;&#x5462;?</span>
    <span class="hljs-keyword">val</span> queuesAndStreams = topicThreadIds.values.map(threadIdSet =&gt;
      threadIdSet.map(_ =&gt; {
        <span class="hljs-keyword">val</span> queue =  <span class="hljs-keyword">new</span> <span class="hljs-type">LinkedBlockingQueue</span>[<span class="hljs-type">FetchedDataChunk</span>](config.queuedMaxMessages)
        <span class="hljs-keyword">val</span> stream = <span class="hljs-keyword">new</span> <span class="hljs-type">KafkaStream</span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>](queue, config.consumerTimeoutMs, keyDecoder, valueDecoder, config.clientId)
        (queue, stream)
      })
    ).flatten.toList  <span class="hljs-comment">//threadIdSet&#x662F;&#x4E2A;&#x96C6;&#x5408;,&#x5916;&#x5C42;&#x7684;topicThreadIds.values&#x4E5F;&#x662F;&#x96C6;&#x5408;,&#x6240;&#x4EE5;&#x7528;flatten&#x538B;&#x6241;&#x4E3A; queue-stream&#x5BF9;</span>

    <span class="hljs-keyword">val</span> dirs = <span class="hljs-keyword">new</span> <span class="hljs-type">ZKGroupDirs</span>(config.groupId)                  <span class="hljs-comment">// /consumers/[group_id]</span>
    registerConsumerInZK(dirs, consumerIdString, topicCount)    <span class="hljs-comment">// /consumers/[group_id]/ids/[consumer_id]</span>
    reinitializeConsumer(topicCount, queuesAndStreams)          <span class="hljs-comment">// &#x91CD;&#x65B0;&#x521D;&#x59CB;&#x5316;&#x6D88;&#x8D39;&#x8005; &#x2B05;&#xFE0F;</span>

    <span class="hljs-comment">// &#x8FD4;&#x56DE;KafkaStream, &#x6BCF;&#x4E2A;Topic&#x90FD;&#x5BF9;&#x5E94;&#x4E86;&#x591A;&#x4E2A; KafkaStream. &#x6570;&#x91CF;&#x548C;topicCount&#x4E2D;&#x7684; count&#x4E00;&#x6837;</span>
    loadBalancerListener.kafkaMessageAndMetadataStreams.asInstanceOf[<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>]]]]
  }
</code></pre>
<p>consumerIdString&#x4F1A;&#x8FD4;&#x56DE;&#x5F53;&#x524D; Consumer&#x5728;&#x54EA;&#x4E2A; ConsumerGroup&#x7684;&#x7F16;&#x53F7;.&#x6BCF;&#x4E2A;consumer&#x5728;&#x6D88;&#x8D39;&#x7EC4;&#x4E2D;&#x7684;&#x7F16;&#x53F7;&#x90FD;&#x662F;&#x552F;&#x4E00;&#x7684;.
&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;,&#x5BF9;&#x4E00;&#x4E2A;topic&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;&#x4E00;&#x8D77;&#x6D88;&#x8D39;(&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;). &#x5F53;&#x7136;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x4E5F;&#x53EF;&#x4EE5;&#x6D88;&#x8D39;&#x591A;&#x4E2A;topic.</p>
<pre><code class="lang-scala">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">makeConsumerThreadIdsPerTopic</span></span>(consumerIdString: <span class="hljs-type">String</span>, topicCountMap: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,  <span class="hljs-type">Int</span>]) = {
    <span class="hljs-keyword">val</span> consumerThreadIdsPerTopicMap = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Set</span>[<span class="hljs-type">ConsumerThreadId</span>]]()
    <span class="hljs-keyword">for</span> ((topic, nConsumers) &lt;- topicCountMap) {                <span class="hljs-comment">// &#x6BCF;&#x4E2A;topic&#x6709;&#x51E0;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B;</span>
      <span class="hljs-keyword">val</span> consumerSet = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashSet</span>[<span class="hljs-type">ConsumerThreadId</span>]   <span class="hljs-comment">// &#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;ConsumerThreadId</span>
      <span class="hljs-keyword">for</span> (i &lt;- <span class="hljs-number">0</span> until nConsumers)
        consumerSet += <span class="hljs-type">ConsumerThreadId</span>(consumerIdString, i)
      consumerThreadIdsPerTopicMap.put(topic, consumerSet)      <span class="hljs-comment">// &#x6BCF;&#x4E2A;topic&#x90FD;&#x6709;&#x591A;&#x4E2A; Consumer&#x7EBF;&#x7A0B;,&#x4F46;&#x662F;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x8FDB;&#x7A0B;</span>
    }
    consumerThreadIdsPerTopicMap                                <span class="hljs-comment">// topic&#x5230;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B;&#x96C6;&#x5408;&#x7684;&#x6620;&#x5C04;</span>
  }
</code></pre>
<p>&#x5047;&#x8BBE;&#x6D88;&#x8D39;&#x8005;C1&#x58F0;&#x660E;&#x4E86;topic1:2, topic2:3. topicThreadIds=consumerThreadIdsPerTopicMap.
topicThreadIds.values = [ (C1_1,C1_2), (C1_1,C1_2,C1_3)]&#x4E00;&#x5171;&#x6709;5&#x4E2A;&#x7EBF;&#x7A0B;,queuesAndStreams&#x4E5F;&#x6709;5&#x4E2A;&#x5143;&#x7D20;.</p>
<pre><code class="lang-?">consumerThreadIdsPerTopicMap = {
    topic1: [C1_1, C1_2],
    topic2: [C1_1, C1_2, C1_3]
}
topicThreadIds.values = [
    [C1_1, C1_2],
    [C1_1, C1_2, C1_3]
]
threadIdSet&#x5FAA;&#x73AF;[C1_1, C1_2]&#x65F6;, &#x751F;&#x6210;&#x4E24;&#x4E2A;queue-&gt;stream pair. 
threadIdSet&#x5FAA;&#x73AF;[C1_1, C1_2, C1_3]&#x65F6;, &#x751F;&#x6210;&#x4E09;&#x4E2A;queue-&gt;stream pair. 
queuesAndStreams = [
    (LinkedBlockingQueue_1,KafkaStream_1),      //topic1:C1_1
    (LinkedBlockingQueue_2,KafkaStream_2),      //topic1:C1_2
    (LinkedBlockingQueue_3,KafkaStream_3),      //topic2:C1_1
    (LinkedBlockingQueue_4,KafkaStream_4),      //topic2:C1_2
    (LinkedBlockingQueue_5,KafkaStream_5),      //topic2:C1_3
]
</code></pre>
<p>&#x5BF9;&#x4E8E;&#x6D88;&#x8D39;&#x8005;&#x800C;&#x8A00;,&#x5B83;&#x53EA;&#x8981;&#x6307;&#x5B9A;&#x8981;&#x6D88;&#x8D39;&#x7684;topic&#x548C;&#x7EBF;&#x7A0B;&#x6570;&#x91CF;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;,&#x5176;&#x4ED6;&#x5177;&#x4F53;&#x8FD9;&#x4E2A;topic&#x5206;&#x6210;&#x591A;&#x5C11;&#x4E2A; partition,
&#x4EE5;&#x53CA;topic-partition&#x662F;&#x5206;&#x5E03;&#x662F;&#x54EA;&#x4E2A; broker&#x4E0A;,&#x5BF9;&#x4E8E;&#x5BA2;&#x6237;&#x7AEF;&#x800C;&#x8A00;&#x90FD;&#x662F;&#x900F;&#x660E;&#x7684;.
&#x5BA2;&#x6237;&#x7AEF;&#x5173;&#x6CE8;&#x7684;&#x662F;&#x6211;&#x7684;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x90FD;&#x5BF9;&#x5E94;&#x4E86;&#x4E00;&#x4E2A;&#x961F;&#x5217;,&#x6BCF;&#x4E2A;&#x961F;&#x5217;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x6D41;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;.
&#x5728;Producer&#x4EE5;&#x53CA;&#x524D;&#x9762;&#x5206;&#x6790;&#x7684; Fetcher,&#x90FD;&#x662F;&#x4EE5;Broker-Topic-Partition&#x4E3A;&#x7EA7;&#x522B;&#x7684;.
AbstractFetcherManager&#x7684; fetcherThreadMap&#x5C31;&#x662F;&#x4EE5; brokerAndFetcherId&#x6765;&#x521B;&#x5EFA;&#x62C9;&#x53D6;&#x7EBF;&#x7A0B;&#x7684;.
&#x800C;&#x6D88;&#x8D39;&#x8005;&#x662F;&#x901A;&#x8FC7;&#x62C9;&#x53D6;&#x7EBF;&#x7A0B;&#x624D;&#x6709;&#x6570;&#x636E;&#x53EF;&#x4EE5;&#x6D88;&#x8D39;&#x7684;,&#x6240;&#x4EE5;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x5B9E;&#x9645;&#x4E0A;&#x4E5F;&#x662F;&#x9488;&#x5BF9;Partition&#x7EA7;&#x522B;&#x7684;.</p>
<h2 id="registerconsumerinzk">registerConsumerInZK</h2>
<p>&#x6D88;&#x8D39;&#x8005;&#x9700;&#x8981;&#x5411;ZK&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x8282;&#x70B9;,&#x8282;&#x70B9;&#x5185;&#x5BB9;&#x4E3A;&#x8BA2;&#x9605;&#x7684;topic.</p>
<pre><code class="lang-scala">  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">registerConsumerInZK</span></span>(dirs: <span class="hljs-type">ZKGroupDirs</span>, consumerIdString: <span class="hljs-type">String</span>, topicCount: <span class="hljs-type">TopicCount</span>) {
    <span class="hljs-keyword">val</span> consumerRegistrationInfo = <span class="hljs-type">Json</span>.encode(<span class="hljs-type">Map</span>(<span class="hljs-string">&quot;version&quot;</span> -&gt; <span class="hljs-number">1</span>, <span class="hljs-string">&quot;subscription&quot;</span> -&gt; topicCount.getTopicCountMap, <span class="hljs-string">&quot;pattern&quot;</span> -&gt; topicCount.pattern, <span class="hljs-string">&quot;timestamp&quot;</span> -&gt; timestamp))
    <span class="hljs-keyword">val</span> zkWatchedEphemeral = <span class="hljs-keyword">new</span> <span class="hljs-type">ZKCheckedEphemeral</span>(dirs.consumerRegistryDir + <span class="hljs-string">&quot;/&quot;</span> + consumerIdString, consumerRegistrationInfo, zkUtils.zkConnection.getZookeeper, <span class="hljs-literal">false</span>)
    zkWatchedEphemeral.create()
  }
</code></pre>
<blockquote>
<p>&#x95EE;&#x9898;:&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x8FD9;&#x4E2A;&#x8282;&#x70B9;&#x4F1A;&#x88AB;&#x5220;&#x9664;&#x6389;&#x5462;? Consumer&#x8FDB;&#x7A0B;&#x6302;&#x6389;&#x65F6;,&#x6216;&#x8005;Session&#x5931;&#x6548;&#x65F6;&#x5220;&#x9664;&#x4E34;&#x65F6;&#x8282;&#x70B9;. &#x91CD;&#x8FDE;&#x65F6;&#x4F1A;&#x91CD;&#x65B0;&#x521B;&#x5EFA;.</p>
</blockquote>
<h2 id="reinitializeconsumer-listener">reinitializeConsumer listener</h2>
<p>&#x5F53;&#x524D;Consumer&#x5728; ZK&#x6CE8;&#x518C;&#x4E4B;&#x540E;,&#x9700;&#x8981;&#x91CD;&#x65B0;&#x521D;&#x59CB;&#x5316;Consumer. &#x5BF9;&#x4E8E;&#x5168;&#x65B0;&#x7684;&#x6D88;&#x8D39;&#x8005;,&#x6CE8;&#x518C;&#x591A;&#x4E2A;&#x76D1;&#x542C;&#x5668;,&#x5728;zk&#x7684;&#x5BF9;&#x5E94;&#x8282;&#x70B9;&#x7684;&#x6CE8;&#x518C;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x65F6;,&#x4F1A;&#x56DE;&#x8C03;&#x76D1;&#x542C;&#x5668;&#x7684;&#x65B9;&#x6CD5;.</p>
<ul>
<li>&#x5C06;topic&#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B; id&#x53CA;&#x5BF9;&#x5E94;&#x7684; LinkedBlockingQueue&#x653E;&#x5165; topicThreadIdAndQueues&#x4E2D;,LinkedBlockingQueue&#x662F;&#x771F;&#x6B63;&#x5B58;&#x653E;&#x6570;&#x636E;&#x7684; queue</li>
<li>&#x2460; &#x6CE8;&#x518C;sessionExpirationListener,&#x76D1;&#x542C;&#x72B6;&#x6001;&#x53D8;&#x5316;&#x4E8B;&#x4EF6;.&#x5728;session&#x5931;&#x6548;&#x91CD;&#x65B0;&#x521B;&#x5EFA; session&#x65F6;&#x8C03;&#x7528;</li>
<li>&#x2461; &#x5411;/consumers/group/ids&#x6CE8;&#x518C; Child&#x53D8;&#x66F4;&#x4E8B;&#x4EF6;&#x7684; loadBalancerListener,&#x5F53;&#x6D88;&#x8D39;&#x7EC4;&#x4E0B;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#x8C03;&#x7528;</li>
<li>&#x2462; &#x5411;/brokers/topics/topic&#x6CE8;&#x518C; Data&#x53D8;&#x66F4;&#x4E8B;&#x4EF6;&#x7684; topicPartitionChangeListener,&#x5728;topic&#x6570;&#x636E;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#x8C03;&#x7528;</li>
<li>&#x663E;&#x5F0F;&#x8C03;&#x7528;loadBalancerListener.syncedRebalance(), &#x4F1A;&#x8C03;&#x7528; rebalance&#x65B9;&#x6CD5;&#x8FDB;&#x884C; consumer&#x7684;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;</li>
</ul>
<pre><code class="lang-scala">  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reinitializeConsumer</span></span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>](topicCount: <span class="hljs-type">TopicCount</span>, queuesAndStreams: <span class="hljs-type">List</span>[(<span class="hljs-type">LinkedBlockingQueue</span>[<span class="hljs-type">FetchedDataChunk</span>],<span class="hljs-type">KafkaStream</span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>])]) {
    <span class="hljs-keyword">val</span> dirs = <span class="hljs-keyword">new</span> <span class="hljs-type">ZKGroupDirs</span>(config.groupId)
    <span class="hljs-comment">// &#x2461; listener to consumer and partition changes</span>
    <span class="hljs-keyword">if</span> (loadBalancerListener == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">val</span> topicStreamsMap = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">String</span>,<span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[<span class="hljs-type">K</span>,<span class="hljs-type">V</span>]]]
      loadBalancerListener = <span class="hljs-keyword">new</span> <span class="hljs-type">ZKRebalancerListener</span>(config.groupId, consumerIdString, topicStreamsMap.asInstanceOf[scala.collection.mutable.<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[_,_]]]])
    }
    <span class="hljs-comment">// &#x2460; create listener for session expired event if not exist yet</span>
    <span class="hljs-keyword">if</span> (sessionExpirationListener == <span class="hljs-literal">null</span>) sessionExpirationListener = <span class="hljs-keyword">new</span> <span class="hljs-type">ZKSessionExpireListener</span>(dirs, consumerIdString, topicCount, loadBalancerListener)
    <span class="hljs-comment">// &#x2462; create listener for topic partition change event if not exist yet</span>
    <span class="hljs-keyword">if</span> (topicPartitionChangeListener == <span class="hljs-literal">null</span>) topicPartitionChangeListener = <span class="hljs-keyword">new</span> <span class="hljs-type">ZKTopicPartitionChangeListener</span>(loadBalancerListener)

    <span class="hljs-comment">// listener to consumer and partition changes</span>
    zkUtils.zkClient.subscribeStateChanges(sessionExpirationListener)
    zkUtils.zkClient.subscribeChildChanges(dirs.consumerRegistryDir, loadBalancerListener)
    <span class="hljs-comment">// register on broker partition path changes.</span>
    topicStreamsMap.foreach { topicAndStreams =&gt; 
      zkUtils.zkClient.subscribeDataChanges(<span class="hljs-type">BrokerTopicsPath</span> + <span class="hljs-string">&quot;/&quot;</span> + topicAndStreams._1, topicPartitionChangeListener)
    }

    <span class="hljs-comment">// explicitly trigger load balancing for this consumer</span>
    loadBalancerListener.syncedRebalance()
  }
</code></pre>
<p>ZKRebalancerListener&#x4F20;&#x5165; ZKSessionExpireListener&#x548C; ZKTopicPartitionChangeListener.&#x5B83;&#x4EEC;&#x90FD;&#x4F1A;&#x4F7F;&#x7528; ZKRebalancerListener&#x5B8C;&#x6210;&#x81EA;&#x5DF1;&#x7684;&#x5DE5;&#x4F5C;.</p>
<h3 id="zksessionexpirelistener">ZKSessionExpireListener</h3>
<p>&#x5F53;Session&#x5931;&#x6548;&#x65F6;,&#x65B0;&#x7684;&#x4F1A;&#x8BDD;&#x5EFA;&#x7ACB;&#x65F6;,&#x7ACB;&#x5373;&#x8FDB;&#x884C;rebalance&#x64CD;&#x4F5C;.</p>
<pre><code class="lang-scala">  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZKSessionExpireListener</span>(<span class="hljs-params">val dirs: <span class="hljs-type">ZKGroupDirs</span>, val consumerIdString: <span class="hljs-type">String</span>, val topicCount: <span class="hljs-type">TopicCount</span>, val loadBalancerListener: <span class="hljs-type">ZKRebalancerListener</span></span>) </span>
    <span class="hljs-keyword">extends</span> <span class="hljs-type">IZkStateListener</span> {
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handleNewSession</span></span>() {
      loadBalancerListener.resetState()
      registerConsumerInZK(dirs, consumerIdString, topicCount)
      loadBalancerListener.syncedRebalance()
    }
  }
</code></pre>
<h3 id="zktopicpartitionchangelistener">ZKTopicPartitionChangeListener</h3>
<p>&#x5F53;topic&#x7684;&#x6570;&#x636E;&#x53D8;&#x5316;&#x65F6;,&#x901A;&#x8FC7;&#x89E6;&#x53D1;&#x7684;&#x65B9;&#x5F0F;&#x542F;&#x52A8;rebalance&#x64CD;&#x4F5C;.</p>
<pre><code class="lang-scala">  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZKTopicPartitionChangeListener</span>(<span class="hljs-params">val loadBalancerListener: <span class="hljs-type">ZKRebalancerListener</span></span>) </span>
    <span class="hljs-keyword">extends</span> <span class="hljs-type">IZkDataListener</span> {
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handleDataChange</span></span>(dataPath : <span class="hljs-type">String</span>, data: <span class="hljs-type">Object</span>) {
      loadBalancerListener.rebalanceEventTriggered()
    }
  }
<span class="hljs-type">ZKRebalancerListener</span> watcher
  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZKRebalancerListener</span>(<span class="hljs-params">val group: <span class="hljs-type">String</span>, val consumerIdString: <span class="hljs-type">String</span>,
                             val kafkaMessageAndMetadataStreams: mutable.<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[_,_]]]</span>)</span>
    <span class="hljs-keyword">extends</span> <span class="hljs-type">IZkChildListener</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isWatcherTriggered = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> lock = <span class="hljs-keyword">new</span> <span class="hljs-type">ReentrantLock</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cond = lock.newCondition()

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> watcherExecutorThread = <span class="hljs-keyword">new</span> <span class="hljs-type">Thread</span>(consumerIdString + <span class="hljs-string">&quot;_watcher_executor&quot;</span>) {
      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span></span>() {
        <span class="hljs-keyword">var</span> doRebalance = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">while</span> (!isShuttingDown.get) {
            lock.lock()
            <span class="hljs-keyword">try</span> {
              <span class="hljs-comment">// &#x5982;&#x679C;isWatcherTriggered=false,&#x5219;&#x4E0D;&#x4F1A;&#x89E6;&#x53D1;syncedRebalance. &#x7B49;&#x5F85;1&#x79D2;&#x540E;,&#x7EE7;&#x7EED;&#x5224;&#x65AD;</span>
              <span class="hljs-keyword">if</span> (!isWatcherTriggered)
                cond.await(<span class="hljs-number">1000</span>, <span class="hljs-type">TimeUnit</span>.<span class="hljs-type">MILLISECONDS</span>) <span class="hljs-comment">// wake up periodically so that it can check the shutdown flag</span>
            } <span class="hljs-keyword">finally</span> {
              <span class="hljs-comment">// &#x4E0D;&#x7BA1;isWatcherTriggered&#x503C;&#x662F;&#x591A;&#x5C11;,&#x5728;&#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#x65F6;,&#x90FD;&#x4F1A;&#x6267;&#x884C;. &#x5982;&#x679C;isWatcherTriggered=true,&#x5219;&#x4F1A;&#x6267;&#x884C;syncedRebalance</span>
              doRebalance = isWatcherTriggered
              <span class="hljs-comment">// &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;isWatcherTriggered=false, &#x56E0;&#x4E3A;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x89E6;&#x53D1;&#x4E00;&#x6B21;&#x540E;&#x5C31;&#x5931;&#x6548;&#x4E86;,&#x60F3;&#x8981;&#x518D;&#x6B21;&#x89E6;&#x53D1;,&#x5FC5;&#x987B;&#x518D;&#x6B21;&#x8BBE;&#x7F6E;isWatcherTriggered=true</span>
              isWatcherTriggered = <span class="hljs-literal">false</span>
              lock.unlock()
            }
            <span class="hljs-keyword">if</span> (doRebalance) syncedRebalance        <span class="hljs-comment">// &#x53EA;&#x6709;&#x6BCF;&#x6B21;rebalanceEventTriggered&#x65F6;,&#x624D;&#x4F1A;&#x8C03;&#x7528;&#x4E00;&#x6B21;syncedRebalance</span>
        }
      }
    }
    watcherExecutorThread.start()

    <span class="hljs-comment">// &#x89E6;&#x53D1;rebalance&#x5F00;&#x59CB;&#x8FDB;&#x884C;, &#x4FEE;&#x6539;isWatcherTriggered&#x6807;&#x5FD7;&#x4F4D;,&#x89E6;&#x53D1;cond&#x6761;&#x4EF6;&#x8FD0;&#x884C;</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rebalanceEventTriggered</span></span>() {
      inLock(lock) {
        isWatcherTriggered = <span class="hljs-literal">true</span>
        cond.signalAll()
      }
    }
</code></pre>
<p><img src="20160126162107763" alt=""></p>
<p>reinitializeConsumer&#x7684; topicStreamsMap&#x662F;&#x4ECE;(topic,thread)-&gt;(queue,stream)&#x6839;&#x636E;topic&#x83B7;&#x53D6; stream&#x5F97;&#x6765;&#x7684;.</p>
<p><img src="20160127113745034" alt=""></p>
<pre><code class="lang-scala">    <span class="hljs-keyword">val</span> topicStreamsMap = loadBalancerListener.kafkaMessageAndMetadataStreams
    <span class="hljs-comment">// map of {topic -&gt; Set(thread-1, thread-2, ...)}</span>
    <span class="hljs-keyword">val</span> consumerThreadIdsPerTopic: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Set</span>[<span class="hljs-type">ConsumerThreadId</span>]] = topicCount.getConsumerThreadIdsPerTopic
    <span class="hljs-comment">// list of (Queue, KafkaStreams): (queue1,stream1),(queue2,stream2),...</span>
    <span class="hljs-keyword">val</span> allQueuesAndStreams = queuesAndStreams 

    <span class="hljs-comment">// (topic,thread-1), (topic,thread-2), ...</span>
    <span class="hljs-keyword">val</span> topicThreadIds = consumerThreadIdsPerTopic.map {
      <span class="hljs-keyword">case</span>(topic, threadIds) =&gt; threadIds.map((topic, _))  <span class="hljs-comment">//&#x4E00;&#x4E2A;topic&#x6709;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;:threadIds,&#x5C06;threadIds&#x4E2D;&#x6BCF;&#x4E2A;threadId&#x90FD;&#x6DFB;&#x52A0;&#x4E0A;topic&#x6807;&#x8BC6;</span>
    }.flatten
    <span class="hljs-comment">// (topic,thread-1), (queue1, stream1)</span>
    <span class="hljs-comment">// (topic,thread-2), (queue2, stream2)</span>
    <span class="hljs-keyword">val</span> threadQueueStreamPairs = topicThreadIds.zip(allQueuesAndStreams)

    threadQueueStreamPairs.foreach(e =&gt; {
      <span class="hljs-keyword">val</span> topicThreadId = e._1  <span class="hljs-comment">// (topic,threadId)</span>
      <span class="hljs-keyword">val</span> q = e._2._1           <span class="hljs-comment">// Queue</span>
      topicThreadIdAndQueues.put(topicThreadId, q)
    })

    <span class="hljs-keyword">val</span> groupedByTopic = threadQueueStreamPairs.groupBy(_._1._1)
    <span class="hljs-comment">// &#x6839;&#x636E;topic&#x5206;&#x7EC4;&#x4E4B;&#x540E;, groupedByTopic&#x7684;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x7684;_1&#x4E3A;topic,_2&#x4E3A;&#x5C5E;&#x4E8E;&#x8FD9;&#x4E2A;topic&#x7684;&#x6240;&#x6709;(topic,thread-1), (queue1, stream1)&#x5F62;&#x5F0F;&#x7684;&#x5217;&#x8868;</span>
    groupedByTopic.foreach(e =&gt; {
      <span class="hljs-keyword">val</span> topic = e._1
      <span class="hljs-comment">// e._2&#x662F;&#x4E00;&#x4E2A;List[((topic,thread),(queue,stream))],&#x4E0B;&#x9762;&#x6536;&#x96C6;&#x8FD9;&#x4E2A;topic&#x7684;&#x6240;&#x6709;stream</span>
      <span class="hljs-keyword">val</span> streams = e._2.map(_._2._2).toList
      topicStreamsMap += (topic -&gt; streams)
    })
</code></pre>
<h2 id="zkrebalancerlistener-rebalance">ZKRebalancerListener rebalance</h2>
<ul>
<li>&#x2460; &#x5173;&#x95ED;&#x6570;&#x636E;&#x6293;&#x53D6;&#x7EBF;&#x7A0B;&#xFF0C;&#x83B7;&#x53D6;&#x4E4B;&#x524D;&#x4E3A;topic&#x8BBE;&#x7F6E;&#x7684;&#x5B58;&#x653E;&#x6570;&#x636E;&#x7684; queue&#x5E76;&#x6E05;&#x7A7A;&#x8BE5; queue</li>
<li>&#x2461; &#x91CA;&#x653E;partition&#x7684; ownership,&#x5220;&#x9664;partition&#x548C; consumer&#x7684;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;</li>
<li>&#x2462; &#x4E3A;&#x5404;&#x4E2A;partition&#x91CD;&#x65B0;&#x5206;&#x914D; threadid</li>
<li>&#x83B7;&#x53D6;partition&#x6700;&#x65B0;&#x7684; offset&#x5E76;&#x91CD;&#x65B0;&#x521D;&#x59CB;&#x5316;&#x65B0;&#x7684; PartitionTopicInfo(queue&#x5B58;&#x653E;&#x6570;&#x636E;,&#x4E24;&#x4E2A;offset&#x4E3A; partition&#x6700;&#x65B0;&#x7684; offset)</li>
<li>&#x2463; &#x91CD;&#x65B0;&#x5C06;partition&#x5BF9;&#x5E94;&#x7684;&#x65B0;&#x7684; consumer&#x4FE1;&#x606F;&#x5199;&#x5165; zookeeper</li>
<li>&#x2464; &#x91CD;&#x65B0;&#x521B;&#x5EFA;partition&#x7684; fetcher&#x7EBF;&#x7A0B;</li>
</ul>
<p><img src="20160126173525524" alt=""></p>
<pre><code class="lang-scala">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rebalance</span></span>(cluster: <span class="hljs-type">Cluster</span>): <span class="hljs-type">Boolean</span> = {
      <span class="hljs-keyword">val</span> myTopicThreadIdsMap = <span class="hljs-type">TopicCount</span>.constructTopicCount(group, consumerIdString, zkUtils, config.excludeInternalTopics).getConsumerThreadIdsPerTopic
      <span class="hljs-keyword">val</span> brokers = zkUtils.getAllBrokersInCluster()
      <span class="hljs-keyword">if</span> (brokers.size == <span class="hljs-number">0</span>) {
        zkUtils.zkClient.subscribeChildChanges(<span class="hljs-type">BrokerIdsPath</span>, loadBalancerListener)
        <span class="hljs-literal">true</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// &#x2460; &#x505C;&#x6B62;fetcher&#x7EBF;&#x7A0B;&#x9632;&#x6B62;&#x6570;&#x636E;&#x91CD;&#x590D;.&#x5982;&#x679C;&#x5F53;&#x524D;&#x8C03;&#x6574;&#x5931;&#x8D25;&#x4E86;,&#x88AB;&#x91CA;&#x653E;&#x7684;partitions&#x53EF;&#x80FD;&#x88AB;&#x5176;&#x4ED6;&#x6D88;&#x8D39;&#x8005;&#x62E5;&#x6709;.&#x800C;&#x6CA1;&#x6709;&#x5148;&#x505C;&#x6B62;fetcher&#x7684;&#x8BDD;,&#x539F;&#x5148;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x4ECD;&#x7136;&#x4F1A;&#x548C;&#x65B0;&#x7684;&#x62E5;&#x6709;&#x8005;&#x5171;&#x540C;&#x6D88;&#x8D39;&#x540C;&#x4E00;&#x4EFD;&#x6570;&#x636E;.  </span>
        closeFetchers(cluster, kafkaMessageAndMetadataStreams, myTopicThreadIdsMap)
        <span class="hljs-comment">// &#x2461; &#x91CA;&#x653E;topicRegistry&#x4E2D;topic-partition&#x7684;owner</span>
        releasePartitionOwnership(topicRegistry)
        <span class="hljs-comment">// &#x2462; &#x4E3A;partition&#x91CD;&#x65B0;&#x5206;&#x914D;&#x6D88;&#x8D39;&#x8005;....</span>
        <span class="hljs-comment">// &#x2463; &#x4E3A;partition&#x6DFB;&#x52A0;consumer owner</span>
        <span class="hljs-keyword">if</span>(reflectPartitionOwnershipDecision(partitionAssignment)) {
            allTopicsOwnedPartitionsCount = partitionAssignment.size
            topicRegistry = currentTopicRegistry
            <span class="hljs-comment">// &#x2464; &#x521B;&#x5EFA;&#x62C9;&#x53D6;&#x7EBF;&#x7A0B;</span>
            updateFetcher(cluster)
            <span class="hljs-literal">true</span>
        }
      }
    }
</code></pre>
<h2 id="partitionownership">PartitionOwnership</h2>
<p>topicRegistry&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x662F;: topic -&gt; (partition -&gt; PartitionTopicInfo), &#x8868;&#x793A;&#x73B0;&#x6709;&#x7684;topic&#x6CE8;&#x518C;&#x4FE1;&#x606F;.
&#x5F53;partition&#x88AB; consumer&#x6240;&#x62E5;&#x6709;&#x540E;, &#x4F1A;&#x5728;zk&#x4E2D;&#x521B;&#x5EFA; /consumers/[group_id]/owner/[topic]/[partition_id] --&gt; consumer_node_id
&#x91CA;&#x653E;&#x6240;&#x6709;partition&#x7684; ownership, &#x6570;&#x636E;&#x6765;&#x6E90;&#x4E8E;topicRegistry&#x7684; topic-partition(&#x6D88;&#x8D39;&#x8005;&#x6240;&#x5C5E;&#x7684;group_id&#x4E5F;&#x662F;&#x786E;&#x5B9A;&#x7684;).
&#x6240;&#x4EE5;deletePartitionOwnershipFromZK&#x4F1A;&#x5220;&#x9664; /consumers/[group_id]/owner/[topic]/[partition_id]&#x8282;&#x70B9;.
&#x8FD9;&#x6837;partition&#x6CA1;&#x6709;&#x4E86; owner,&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;partition&#x4E0D;&#x4F1A;&#x88AB; consumer&#x6D88;&#x8D39;&#x4E86;,&#x4E5F;&#x5C31;&#x76F8;&#x5F53;&#x4E8E;consumer&#x91CA;&#x653E;&#x4E86; partition.</p>
<pre><code class="lang-scala">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">releasePartitionOwnership</span></span>(localTopicRegistry: <span class="hljs-type">Pool</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Pool</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">PartitionTopicInfo</span>]])= {
      <span class="hljs-keyword">for</span> ((topic, infos) &lt;- localTopicRegistry) {
        <span class="hljs-keyword">for</span>(partition &lt;- infos.keys) {
          deletePartitionOwnershipFromZK(topic, partition)
        }
        localTopicRegistry.remove(topic)
      }
      allTopicsOwnedPartitionsCount = <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deletePartitionOwnershipFromZK</span></span>(topic: <span class="hljs-type">String</span>, partition: <span class="hljs-type">Int</span>) {
      <span class="hljs-keyword">val</span> topicDirs = <span class="hljs-keyword">new</span> <span class="hljs-type">ZKGroupTopicDirs</span>(group, topic)
      <span class="hljs-keyword">val</span> znode = topicDirs.consumerOwnerDir + <span class="hljs-string">&quot;/&quot;</span> + partition
      zkUtils.deletePath(znode)
    }
</code></pre>
<p>&#x91CD;&#x5EFA;ownership. &#x53C2;&#x6570;partitionAssignment&#x4F1A;&#x6307;&#x5B9A; partition(TopicAndPartition)&#x8981;&#x5206;&#x914D;&#x7ED9;&#x54EA;&#x4E2A;consumer(ConsumerThreadId)&#x6D88;&#x8D39;&#x7684;.</p>
<pre><code class="lang-scala">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reflectPartitionOwnershipDecision</span></span>(partitionAssignment: <span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">ConsumerThreadId</span>]): <span class="hljs-type">Boolean</span> = {
      <span class="hljs-keyword">var</span> successfullyOwnedPartitions : <span class="hljs-type">List</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">Int</span>)] = <span class="hljs-type">Nil</span>
      <span class="hljs-keyword">val</span> partitionOwnershipSuccessful = partitionAssignment.map { partitionOwner =&gt;
        <span class="hljs-keyword">val</span> topic = partitionOwner._1.topic
        <span class="hljs-keyword">val</span> partition = partitionOwner._1.partition
        <span class="hljs-keyword">val</span> consumerThreadId = partitionOwner._2

        <span class="hljs-comment">// &#x8FD4;&#x56DE;/consumers/[group_id]/owner/[topic]/[partition_id]&#x8282;&#x70B9;&#x8DEF;&#x5F84;,&#x7136;&#x540E;&#x521B;&#x5EFA;&#x8282;&#x70B9;,&#x8282;&#x70B9;&#x5185;&#x5BB9;&#x4E3A;:consumerThreadId</span>
        <span class="hljs-keyword">val</span> partitionOwnerPath = zkUtils.getConsumerPartitionOwnerPath(group, topic, partition)
        zkUtils.createEphemeralPathExpectConflict(partitionOwnerPath, consumerThreadId.toString)

        <span class="hljs-comment">// &#x6210;&#x529F;&#x521B;&#x5EFA;&#x7684;&#x8282;&#x70B9;,&#x52A0;&#x5165;&#x5230;&#x5217;&#x8868;&#x4E2D;</span>
        successfullyOwnedPartitions ::= (topic, partition)
        <span class="hljs-literal">true</span>
      }
      <span class="hljs-comment">// &#x5224;&#x65AD;&#x4E0A;&#x9762;&#x7684;&#x521B;&#x5EFA;&#x8282;&#x70B9;&#x64CD;&#x4F5C;(&#x4E3A;consumer&#x5206;&#x914D;partition)&#x662F;&#x5426;&#x6709;&#x9519;&#x8BEF;,&#x4E00;&#x65E6;&#x6709;&#x4E00;&#x4E2A;&#x6709;&#x95EE;&#x9898;,&#x5C31;&#x5168;&#x90E8;&#x56DE;&#x6EDA;(&#x5220;&#x9664;&#x6389;).&#x53EA;&#x6709;&#x6240;&#x6709;&#x6210;&#x529F;&#x624D;&#x7B97;&#x6210;&#x529F;</span>
      <span class="hljs-keyword">val</span> hasPartitionOwnershipFailed = partitionOwnershipSuccessful.foldLeft(<span class="hljs-number">0</span>)((sum, decision) =&gt; sum + (<span class="hljs-keyword">if</span>(decision) <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>))
      <span class="hljs-keyword">if</span>(hasPartitionOwnershipFailed &gt; <span class="hljs-number">0</span>) {
        successfullyOwnedPartitions.foreach(topicAndPartition =&gt; deletePartitionOwnershipFromZK(topicAndPartition._1, topicAndPartition._2))
        <span class="hljs-literal">false</span>
      } <span class="hljs-keyword">else</span> <span class="hljs-literal">true</span>
    }
</code></pre>
<blockquote>
<p>&#x5173;&#x4E8E;consumer&#x7684;&#x6CE8;&#x518C;&#x8282;&#x70B9;&#x51FA;&#x73B0;&#x7684;&#x5730;&#x65B9;&#x6709;:&#x5F00;&#x59CB;&#x65F6;&#x7684;registerConsumerInZK,&#x4EE5;&#x53CA;&#x8FD9;&#x91CC;&#x7684;&#x5148;&#x91CA;&#x653E;&#x518D;&#x6CE8;&#x518C;.</p>
</blockquote>
<h2 id="assignmentcontext">AssignmentContext</h2>
<p>AssignmentContext&#x662F; PartitionAssignor&#x8981;&#x4E3A;&#x67D0;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x5206;&#x914D;&#x7684;&#x4E0A;&#x4E0B;&#x6587;.&#x56E0;&#x4E3A;&#x6D88;&#x8D39;&#x8005;&#x53EA;&#x8BA2;&#x9605;&#x4E86;&#x7279;&#x5B9A;&#x7684;topic,&#x6240;&#x4EE5;&#x9996;&#x5148;&#x8981;&#x9009;&#x51FA;topic.
&#x6BCF;&#x4E2A;topic&#x90FD;&#x662F;&#x6709; partitions map, &#x8868;&#x793A;&#x8FD9;&#x4E2A;topic&#x6709;&#x54EA;&#x4E9B; partition,&#x4EE5;&#x53CA;&#x5BF9;&#x5E94;&#x7684;replicas.&#x8FDB;&#x800C;&#x5F97;&#x5230;partitionsForTopic.
consumersForTopic:&#x8981;&#x5728;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x8005;&#x6240;&#x5728;&#x7684;&#x6D88;&#x8D39;&#x7EC4;&#x4E2D;,&#x627E;&#x5230;&#x6240;&#x6709;&#x8BA2;&#x9605;&#x4E86;&#x8FD9;&#x4E2A;topic&#x7684;&#x6D88;&#x8D39;&#x8005;.&#x4EE5;topic&#x4E3A;&#x7C92;&#x5EA6;,&#x7EDF;&#x8BA1;&#x6240;&#x6709;&#x7684;&#x7EBF;&#x7A0B;&#x6570;.</p>
<pre><code class="lang-scala">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AssignmentContext</span>(<span class="hljs-params">group: <span class="hljs-type">String</span>, val consumerId: <span class="hljs-type">String</span>, excludeInternalTopics: <span class="hljs-type">Boolean</span>, zkUtils: <span class="hljs-type">ZkUtils</span></span>) </span>{
        <span class="hljs-comment">// &#x5F53;&#x524D;&#x6D88;&#x8D39;&#x8005;&#x7684;&#x6D88;&#x8D39;topic&#x548C;&#x6D88;&#x8D39;&#x7EBF;&#x7A0B;, &#x56E0;&#x4E3A;&#x6307;&#x5B9A;&#x4E86;consumerId,&#x6240;&#x4EE5;&#x662F;&#x9488;&#x5BF9;&#x5F53;&#x524D;consumer&#x800C;&#x8A00;</span>
        <span class="hljs-keyword">val</span> myTopicThreadIds: collection.<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, collection.<span class="hljs-type">Set</span>[<span class="hljs-type">ConsumerThreadId</span>]] = {
            <span class="hljs-keyword">val</span> myTopicCount = <span class="hljs-type">TopicCount</span>.constructTopicCount(group, consumerId, zkUtils, excludeInternalTopics)
            myTopicCount.getConsumerThreadIdsPerTopic
        }
        <span class="hljs-comment">// &#x5C5E;&#x4E8E;&#x67D0;&#x4E2A;topic&#x7684;&#x6240;&#x6709;partitions. &#x5F53;&#x7136;topic&#x662F;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x8005;&#x8BA2;&#x9605;&#x7684;&#x8303;&#x56F4;&#x5185;,&#x5176;&#x4ED6;topic&#x5E76;&#x4E0D;&#x5173;&#x5FC3;</span>
        <span class="hljs-keyword">val</span> partitionsForTopic: collection.<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Seq</span>[<span class="hljs-type">Int</span>]] = zkUtils.getPartitionsForTopics(myTopicThreadIds.keySet.toSeq)

        <span class="hljs-comment">// &#x5728;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x7EC4;&#x5185;,&#x5C5E;&#x4E8E;&#x67D0;&#x4E2A;topic&#x7684;&#x6240;&#x6709;consumers</span>
        <span class="hljs-keyword">val</span> consumersForTopic: collection.<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">List</span>[<span class="hljs-type">ConsumerThreadId</span>]] = zkUtils.getConsumersPerTopic(group, excludeInternalTopics)
        <span class="hljs-keyword">val</span> consumers: <span class="hljs-type">Seq</span>[<span class="hljs-type">String</span>] = zkUtils.getConsumersInGroup(group).sorted
    }
</code></pre>
<p>/brokers/topics/topic_name &#x8BB0;&#x5F55;&#x7684;&#x662F; topic &#x7684; partition&#x5206;&#x914D;&#x60C5;&#x51B5;. &#x83B7;&#x53D6; partition&#x4FE1;&#x606F;,&#x8BFB;&#x53D6;&#x7684;&#x662F;partitions &#x5B57;&#x6BB5;(partitionMap).</p>
<pre><code class="lang-scala">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getPartitionsForTopics</span></span>(topics: <span class="hljs-type">Seq</span>[<span class="hljs-type">String</span>]): mutable.<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Seq</span>[<span class="hljs-type">Int</span>]] = {
    getPartitionAssignmentForTopics(topics).map { topicAndPartitionMap =&gt;
      <span class="hljs-keyword">val</span> topic = topicAndPartitionMap._1
      <span class="hljs-keyword">val</span> partitionMap = topicAndPartitionMap._2
      (topic -&gt; partitionMap.keys.toSeq.sortWith((s,t) =&gt; s &lt; t))
    }
  }
</code></pre>
<p>&#x6BCF;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x90FD;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x6D88;&#x8D39;&#x7684;topic&#x548C;&#x7EBF;&#x7A0B;&#x6570;, &#x5BF9;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x7EC4;&#x4E2D;&#x591A;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x6D88;&#x8D39;&#x540C;&#x4E00;&#x4E2A;topic&#x6216;&#x4E0D;&#x540C; topic.
&#x83B7;&#x53D6;topic&#x7684;&#x6240;&#x6709; consumers&#x65F6;,&#x7EDF;&#x8BA1;&#x6240;&#x6709;&#x6D88;&#x8D39;&#x8FD9;&#x4E2A;topic&#x7684;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B;(&#x539F;&#x5148;&#x4EE5;&#x6D88;&#x8D39;&#x8005;,&#x73B0;&#x5728;&#x8F6C;&#x6362;&#x4E3A;&#x4EE5;topic).</p>
<blockquote>
<p>&#x6CE8;&#x610F;: &#x8FD9;&#x91CC;&#x662F;&#x53D6;&#x51FA;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x7EC4;&#x4E0B;&#x6240;&#x6709;&#x6D88;&#x8D39;&#x8005;&#x7684;&#x6240;&#x6709;topic,&#x5E76;&#x6CA1;&#x6709;&#x8FC7;&#x6EE4;&#x51FA;&#x5C5E;&#x4E8E;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x8005;&#x611F;&#x5174;&#x8DA3;&#x7684;topics.</p>
</blockquote>
<pre><code class="lang-scala">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getConsumersPerTopic</span></span>(group: <span class="hljs-type">String</span>, excludeInternalTopics: <span class="hljs-type">Boolean</span>) : mutable.<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">List</span>[<span class="hljs-type">ConsumerThreadId</span>]] = {
    <span class="hljs-keyword">val</span> dirs = <span class="hljs-keyword">new</span> <span class="hljs-type">ZKGroupDirs</span>(group)
    <span class="hljs-comment">// &#x5F53;&#x524D;&#x6D88;&#x8D39;&#x7EC4;&#x4E0B;&#x6240;&#x6709;&#x7684;consumers</span>
    <span class="hljs-keyword">val</span> consumers = getChildrenParentMayNotExist(dirs.consumerRegistryDir)
    <span class="hljs-keyword">val</span> consumersPerTopicMap = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">String</span>, <span class="hljs-type">List</span>[<span class="hljs-type">ConsumerThreadId</span>]]
    <span class="hljs-keyword">for</span> (consumer &lt;- consumers) {
      <span class="hljs-comment">// &#x6BCF;&#x4E2A;consumer&#x90FD;&#x6307;&#x5B9A;&#x4E86; topic&#x548C; thread-count</span>
      <span class="hljs-keyword">val</span> topicCount = <span class="hljs-type">TopicCount</span>.constructTopicCount(group, consumer, <span class="hljs-keyword">this</span>, excludeInternalTopics)
      <span class="hljs-keyword">for</span> ((topic, consumerThreadIdSet) &lt;- topicCount.getConsumerThreadIdsPerTopic) {
        <span class="hljs-comment">// &#x73B0;&#x5728;&#x662F;&#x5728;&#x540C;&#x4E00;&#x4E2A;consumer&#x91CC;, &#x5BF9;&#x540C;&#x4E00;&#x4E2A;topic,&#x6709;&#x591A;&#x4E2A;thread-id</span>
        <span class="hljs-keyword">for</span> (consumerThreadId &lt;- consumerThreadIdSet)
          <span class="hljs-comment">// &#x6700;&#x540E;&#x6309;&#x7167;topic&#x5206;,&#x800C;&#x4E0D;&#x662F;&#x6309;&#x7167;consumer&#x5206;,&#x6BD4;&#x5982;&#x591A;&#x4E2A;consumer&#x90FD;&#x6D88;&#x8D39;&#x4E86;&#x540C;&#x4E00;&#x4E2A; topic, &#x5219;&#x8FD9;&#x4E9B; consumer&#x4F1A;&#x52A0;&#x5165;&#x5230;&#x540C;&#x4E00;&#x4E2A; topic&#x4E2D;</span>
          consumersPerTopicMap.get(topic) <span class="hljs-keyword">match</span> {
            <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(curConsumers) =&gt; consumersPerTopicMap.put(topic, consumerThreadId :: curConsumers)
            <span class="hljs-keyword">case</span> _ =&gt; consumersPerTopicMap.put(topic, <span class="hljs-type">List</span>(consumerThreadId))
          }
      }
    }
    <span class="hljs-keyword">for</span> ((topic, consumerList) &lt;- consumersPerTopicMap) consumersPerTopicMap.put(topic, consumerList.sortWith((s,t) =&gt; s &lt; t))
    consumersPerTopicMap
  }
</code></pre>
<h2 id="partitionassignor">PartitionAssignor</h2>
<p>&#x5C06;&#x53EF;&#x7528;&#x7684;partitions&#x4EE5;&#x53CA;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B;&#x6392;&#x5E8F;, &#x5C06;partitions&#x5904;&#x4E8E;&#x7EBF;&#x7A0B;&#x6570;,&#x8868;&#x793A;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;(&#x4E0D;&#x662F;&#x6D88;&#x8D39;&#x8005;&#x6570;&#x91CF;)&#x5E73;&#x5747;&#x53EF;&#x4EE5;&#x5206;&#x5230;&#x51E0;&#x4E2A;partition.
&#x5982;&#x679C;&#x9664;&#x4E0D;&#x5C3D;,&#x5269;&#x4F59;&#x7684;&#x4F1A;&#x5206;&#x7ED9;&#x524D;&#x9762;&#x51E0;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B;. &#x6BD4;&#x5982;&#x6709;&#x4E24;&#x4E2A;&#x6D88;&#x8D39;&#x8005;,&#x6BCF;&#x4E2A;&#x90FD;&#x662F;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;,&#x4E00;&#x5171;&#x6709;5&#x4E2A;&#x53EF;&#x7528;&#x7684;partitions:(p0-p4).
&#x6BCF;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B;(&#x4E00;&#x5171;&#x56DB;&#x4E2A;&#x7EBF;&#x7A0B;)&#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x5230;&#x81F3;&#x5C11;&#x4E00;&#x5171;partition(5/4=1),&#x5269;&#x4F59;&#x4E00;&#x4E2A;(5%4=1)partition&#x5206;&#x7ED9;&#x7B2C;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;.
&#x6700;&#x540E;&#x7684;&#x5206;&#x914D;&#x7ED3;&#x679C;&#x4E3A;: p0 -&gt; C1-0, p1 -&gt; C1-0, p2 -&gt; C1-1, p3 -&gt; C2-0, p4 -&gt; C2-1</p>
<p><img src="20160127083105757" alt=""></p>
<pre><code class="lang-scala">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RangeAssignor</span>(<span class="hljs-params"></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">PartitionAssignor</span> <span class="hljs-keyword">with</span> <span class="hljs-title">Logging</span> </span>{
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">assign</span></span>(ctx: <span class="hljs-type">AssignmentContext</span>) = {
            <span class="hljs-keyword">val</span> valueFactory = (topic: <span class="hljs-type">String</span>) =&gt; <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">ConsumerThreadId</span>]
            <span class="hljs-comment">// consumerThreadId -&gt; (TopicAndPartition -&gt; ConsumerThreadId). &#x6240;&#x4EE5;&#x4E0A;&#x9762;&#x7684;valueFactory&#x7684;&#x53C2;&#x6570;&#x4E0D;&#x5BF9;&#x54E6;!</span>
            <span class="hljs-keyword">val</span> partitionAssignment = <span class="hljs-keyword">new</span> <span class="hljs-type">Pool</span>[<span class="hljs-type">String</span>, mutable.<span class="hljs-type">Map</span>[<span class="hljs-type">TopicAndPartition</span>, <span class="hljs-type">ConsumerThreadId</span>]](<span class="hljs-type">Some</span>(valueFactory))
            <span class="hljs-keyword">for</span> (topic &lt;- ctx.myTopicThreadIds.keySet) {
            <span class="hljs-keyword">val</span> curConsumers = ctx.consumersForTopic(topic)                   <span class="hljs-comment">// &#x8BA2;&#x9605;&#x4E86;topic&#x7684;&#x6D88;&#x8D39;&#x8005;&#x5217;&#x8868;(4)</span>
            <span class="hljs-keyword">val</span> curPartitions: <span class="hljs-type">Seq</span>[<span class="hljs-type">Int</span>] = ctx.partitionsForTopic(topic)       <span class="hljs-comment">// &#x5C5E;&#x4E8E;topic&#x7684; partitions(5)</span>
            <span class="hljs-keyword">val</span> nPartsPerConsumer = curPartitions.size / curConsumers.size    <span class="hljs-comment">// &#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x90FD;&#x53EF;&#x4EE5;&#x6709;&#x8FD9;&#x4E9B;&#x4E2A;partition(1)</span>
            <span class="hljs-keyword">val</span> nConsumersWithExtraPart = curPartitions.size % curConsumers.size  <span class="hljs-comment">// &#x5269;&#x4F59;&#x7684;&#x5206;&#x7ED9;&#x524D;&#x9762;&#x51E0;&#x4E2A;(1)</span>
            <span class="hljs-keyword">for</span> (consumerThreadId &lt;- curConsumers) {                          <span class="hljs-comment">// &#x6BCF;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B;: C1_0,C1_1,C2_0,C2_1</span>
                <span class="hljs-keyword">val</span> myConsumerPosition = curConsumers.indexOf(consumerThreadId) <span class="hljs-comment">// &#x7EBF;&#x7A0B;&#x5728;&#x5217;&#x8868;&#x4E2D;&#x7684;&#x7D22;&#x5F15;: 0,1,2,3</span>
                <span class="hljs-keyword">val</span> startPart = nPartsPerConsumer * myConsumerPosition + myConsumerPosition.min(nConsumersWithExtraPart)
                <span class="hljs-keyword">val</span> nParts = nPartsPerConsumer + (<span class="hljs-keyword">if</span> (myConsumerPosition + <span class="hljs-number">1</span> &gt; nConsumersWithExtraPart) <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>)
                <span class="hljs-comment">// Range-partition the sorted partitions to consumers for better locality. The first few consumers pick up an extra partition, if any.</span>
                <span class="hljs-keyword">if</span> (nParts &gt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">for</span> (i &lt;- startPart until startPart + nParts) {
                    <span class="hljs-keyword">val</span> partition = curPartitions(i)
                    <span class="hljs-comment">// record the partition ownership decision &#x8BB0;&#x5F55;partition&#x7684; ownership&#x51B3;&#x5B9A;,&#x5373;&#x628A;partition&#x5206;&#x914D;&#x7ED9; consumerThreadId</span>
                    <span class="hljs-keyword">val</span> assignmentForConsumer = partitionAssignment.getAndMaybePut(consumerThreadId.consumer)
                    assignmentForConsumer += (<span class="hljs-type">TopicAndPartition</span>(topic, partition) -&gt; consumerThreadId)
                }
                }
            }
            }
            <span class="hljs-comment">// &#x524D;&#x9762;&#x7684;for&#x5FAA;&#x73AF;&#x4E2D;&#x7684; consumers&#x662F;&#x548C;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x8005;&#x6709;&#x76F8;&#x540C; topic&#x7684;,&#x5982;&#x679C;&#x6D88;&#x8D39;&#x8005;&#x7684;topic&#x548C;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x8005;&#x4E0D;&#x4E00;&#x6837;,&#x5219;&#x5728;&#x672C;&#x6B21;assign&#x4E2D;&#x4E0D;&#x4F1A;&#x4E3A;&#x5B83;&#x5206;&#x914D;&#x7684;.</span>
            <span class="hljs-comment">// assign Map.empty for the consumers which are not associated with topic partitions &#x6CA1;&#x6709;&#x548C;partition&#x5173;&#x8054;&#x7684; consumer&#x5206;&#x914D;&#x7A7A;&#x7684; partition.</span>
            ctx.consumers.foreach(consumerId =&gt; partitionAssignment.getAndMaybePut(consumerId))
            partitionAssignment
        }
    }
</code></pre>
<p>&#x5047;&#x8BBE;&#x6709;&#x5982;&#x4E0B;&#x7684;&#x6D88;&#x8D39;&#x8005;-&#x8BA2;&#x9605;topic&#x7684;&#x5173;&#x7CFB;.</p>
<p><img src="20160127083148382" alt=""></p>
<p>&#x9996;&#x5148;&#x627E;&#x5230;&#x548C;consumer1&#x6709;&#x76F8;&#x540C;&#x8BA2;&#x9605;&#x4E3B;&#x9898;&#x7684;&#x6D88;&#x8D39;&#x8005;</p>
<p><img src="20160127083206226" alt=""></p>
<p>&#x5BF9;&#x4E8E;consumer1&#x7684;&#x6240;&#x6709;topic, &#x5206;&#x914D;&#x7ED9;&#x6709;&#x8FD9;&#x4E2A;&#x8BA2;&#x9605;&#x5173;&#x7CFB;&#x7684;&#x6240;&#x6709;&#x8BA2;&#x9605;&#x8005;</p>
<p><img src="20160127083219632" alt=""></p>
<h2 id="partitionassignment---partitiontopicinfo">PartitionAssignment -&gt; PartitionTopicInfo</h2>
<p>&#x8FD9;&#x662F;ZKRebalancerListener.rebalance&#x7684;&#x7B2C;&#x4E09;&#x6B65;.&#x9996;&#x5148;&#x4E3A;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x8005;&#x521B;&#x5EFA;AssignmentContext&#x4E0A;&#x4E0B;&#x6587;.
&#x4E0A;&#x9762;&#x77E5;&#x9053;partitionAssignor.assign&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#x6240;&#x6709; consumer&#x7684;&#x5206;&#x914D;&#x7ED3;&#x679C;(&#x867D;&#x7136;&#x6709;&#x4E9B; consumer&#x5728;&#x672C;&#x6B21;&#x4E2D;&#x5E76;&#x6CA1;&#x6709;&#x5206;&#x5230; partition)
partitionAssignment&#x7684;&#x7ED3;&#x6784;&#x662F; consumerThreadId -&gt; (TopicAndPartition -&gt; ConsumerThreadId),
&#x6240;&#x4EE5;&#x83B7;&#x53D6;&#x5F53;&#x524D;consumer&#x53EA;&#x8981;&#x4F20;&#x5165; assignmentContext.consumerId&#x5C31;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x8005;&#x7684; PartitionAssignment.</p>
<pre><code class="lang-scala">        <span class="hljs-comment">// &#x2462; &#x4E3A;partition&#x91CD;&#x65B0;&#x9009;&#x62E9; consumer</span>
        <span class="hljs-keyword">val</span> assignmentContext = <span class="hljs-keyword">new</span> <span class="hljs-type">AssignmentContext</span>(group, consumerIdString, config.excludeInternalTopics, zkUtils)
        <span class="hljs-keyword">val</span> globalPartitionAssignment = partitionAssignor.assign(assignmentContext)
        <span class="hljs-keyword">val</span> partitionAssignment = globalPartitionAssignment.get(assignmentContext.consumerId)
        <span class="hljs-keyword">val</span> currentTopicRegistry = <span class="hljs-keyword">new</span> <span class="hljs-type">Pool</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Pool</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">PartitionTopicInfo</span>]](valueFactory = <span class="hljs-type">Some</span>((topic: <span class="hljs-type">String</span>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">Pool</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">PartitionTopicInfo</span>]))

        <span class="hljs-comment">// fetch current offsets for all topic-partitions</span>
        <span class="hljs-keyword">val</span> topicPartitions = partitionAssignment.keySet.toSeq
        <span class="hljs-keyword">val</span> offsetFetchResponseOpt = fetchOffsets(topicPartitions)
        <span class="hljs-keyword">val</span> offsetFetchResponse = offsetFetchResponseOpt.get
        topicPartitions.foreach(topicAndPartition =&gt; {
            <span class="hljs-keyword">val</span> (topic, partition) = topicAndPartition.asTuple
            <span class="hljs-keyword">val</span> offset = offsetFetchResponse.requestInfo(topicAndPartition).offset
            <span class="hljs-keyword">val</span> threadId = partitionAssignment(topicAndPartition)
            addPartitionTopicInfo(currentTopicRegistry, partition, topic, offset, threadId)
        })

        <span class="hljs-comment">// &#x2463; &#x2464; &#x6CE8;&#x518C;&#x5230;zk&#x4E0A;, &#x5E76;&#x521B;&#x5EFA;&#x65B0;&#x7684;fetcher&#x7EBF;&#x7A0B;</span>
        <span class="hljs-keyword">if</span>(reflectPartitionOwnershipDecision(partitionAssignment)) {
            topicRegistry = currentTopicRegistry  <span class="hljs-comment">// topicRegistry&#x6765;&#x81EA;&#x4E0A;&#x4E00;&#x6B65;&#x7684; addPartitionTopicInfo, &#x5B83;&#x4F1A;&#x88AB;&#x7528;&#x4E8E;updateFetcher</span>
            updateFetcher(cluster)
        }
</code></pre>
<p>PartitionAssignment&#x7684; key&#x662F; TopicAndPartition,&#x6839;&#x636E;&#x6240;&#x6709;topicAndPartitions&#x83B7;&#x53D6;&#x8FD9;&#x4E9B; partitions&#x7684; offsets.
&#x8FD4;&#x56DE;&#x503C;offsetFetchResponse&#x5305;&#x542B;&#x4E86;&#x5BF9;&#x5E94;&#x7684; offset, &#x6700;&#x7EC8;&#x6839;&#x636E;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x521B;&#x5EFA;&#x5BF9;&#x5E94;&#x7684;PartitionTopicInfo.
PartitionTopicInfo&#x5305;&#x542B; Partition&#x548C; Topic:&#x961F;&#x5217;&#x7528;&#x6765;&#x5B58;&#x653E;&#x6570;&#x636E;(topicThreadIdAndQueues&#x5728; reinitializeConsumer&#x4E2D;&#x653E;&#x5165;),
consumedOffset&#x548C; fetchedOffset&#x90FD;&#x662F;&#x6765;&#x81EA;&#x4E8E; offset&#x53C2;&#x6570;,&#x5373;&#x4E0A;&#x9762;offsetFetchResponse&#x4E2D; partition&#x7684; offset.</p>
<p>currentTopicRegistry&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4E5F;&#x5F88;&#x91CD;&#x8981;: topic -&gt; (partition -&gt; PartitionTopicInfo)
key&#x662F; topic, &#x6B63;&#x5982;&#x540D;&#x79F0;&#x6240;&#x793A;&#x662F;topic&#x7684;&#x6CE8;&#x518C;&#x4FE1;&#x606F;(topicRegistry).&#x53C8;&#x56E0;&#x4E3A;&#x6765;&#x81EA;&#x4E8E;fetchOffsets,&#x6240;&#x4EE5;&#x8868;&#x793A;&#x7684;&#x662F;&#x6700;&#x65B0;&#x5F53;&#x524D;&#x7684;.</p>
<pre><code class="lang-scala">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">addPartitionTopicInfo</span></span>(currentTopicRegistry: <span class="hljs-type">Pool</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Pool</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">PartitionTopicInfo</span>]],
                                      partition: <span class="hljs-type">Int</span>, topic: <span class="hljs-type">String</span>, offset: <span class="hljs-type">Long</span>, consumerThreadId: <span class="hljs-type">ConsumerThreadId</span>) {
      <span class="hljs-keyword">val</span> partTopicInfoMap = currentTopicRegistry.getAndMaybePut(topic)
      <span class="hljs-keyword">val</span> queue = topicThreadIdAndQueues.get((topic, consumerThreadId))
      <span class="hljs-keyword">val</span> consumedOffset = <span class="hljs-keyword">new</span> <span class="hljs-type">AtomicLong</span>(offset)
      <span class="hljs-keyword">val</span> fetchedOffset = <span class="hljs-keyword">new</span> <span class="hljs-type">AtomicLong</span>(offset)
      <span class="hljs-keyword">val</span> partTopicInfo = <span class="hljs-keyword">new</span> <span class="hljs-type">PartitionTopicInfo</span>(topic,partition,queue,consumedOffset,fetchedOffset,<span class="hljs-keyword">new</span> <span class="hljs-type">AtomicInteger</span>(config.fetchMessageMaxBytes), config.clientId)
      partTopicInfoMap.put(partition, partTopicInfo)
      checkpointedZkOffsets.put(<span class="hljs-type">TopicAndPartition</span>(topic, partition), offset)
    }
  }
</code></pre>
<blockquote>
<p>&#x6CE8;&#x610F;:&#x4E00;&#x4E2A;threadId&#x53EF;&#x4EE5;&#x6D88;&#x8D39;&#x540C;&#x4E00;&#x4E2A; topic&#x7684;&#x591A;&#x4E2A; partition. &#x800C;&#x4E00;&#x4E2A;threadId&#x5BF9;&#x5E94;&#x4E00;&#x4E2A; queue.
&#x6240;&#x4EE5;&#x4E00;&#x4E2A;queue&#x4E5F;&#x5C31;&#x53EF;&#x4EE5;&#x6D88;&#x8D39;&#x591A;&#x4E2A; partition. &#x5373;&#x5BF9;&#x4E8E;&#x4E0D;&#x540C;&#x7684;partition,&#x53EF;&#x80FD;&#x4F7F;&#x7528;&#x540C;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#x6765;&#x6D88;&#x8D39;.
&#x6BD4;&#x5982;&#x6D88;&#x8D39;&#x8005;&#x8BBE;&#x7F6E;&#x4E86;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;,&#x5C31;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x961F;&#x5217;,&#x800C;partition&#x5206;&#x4E86;&#x4E24;&#x4E2A;&#x7ED9;&#x5B83;,&#x8FD9;&#x6837;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#x5C31;&#x8981;&#x5904;&#x7406;&#x4E24;&#x4E2A;partition&#x4E86;.</p>
</blockquote>
<p><img src="20160127083346742" alt=""></p>
<h2 id="updatefetcher--closefetchers">updateFetcher &amp; closeFetchers</h2>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x4E86;&#x5728;ZooKeeperConsumerConnector&#x521D;&#x59CB;&#x5316;&#x65F6;&#x521B;&#x5EFA;&#x7684; fetcher(ConsumerFetcherManager)&#x7EC8;&#x4E8E;&#x6D3E;&#x4E0A;&#x7528;&#x573A;&#x4E86;.
allPartitionInfos&#x662F;&#x5206;&#x914D;&#x7ED9; Consumer&#x7684; Partition&#x5217;&#x8868;(&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x8FD8;&#x4E0D;&#x77E5;&#x9053;Leader&#x7684;,&#x6240;&#x4EE5;&#x5728; Manager&#x4E2D;&#x8981;&#x81EA;&#x5DF1;&#x5BFB;&#x627E; Leader).</p>
<pre><code class="lang-scala">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">updateFetcher</span></span>(cluster: <span class="hljs-type">Cluster</span>) {   <span class="hljs-comment">// update partitions for fetcher</span>
      <span class="hljs-keyword">var</span> allPartitionInfos : <span class="hljs-type">List</span>[<span class="hljs-type">PartitionTopicInfo</span>] = <span class="hljs-type">Nil</span>
      <span class="hljs-keyword">for</span> (partitionInfos &lt;- topicRegistry.values)  <span class="hljs-comment">// topicRegistry&#x662F;&#x5728;addPartitionTopicInfo&#x4E2D;&#x52A0;&#x5230;currentTopicRegistry,&#x518D;&#x88AB;&#x8D4B;&#x503C;&#x7ED9;topicRegistry</span>
        <span class="hljs-keyword">for</span> (partition &lt;- partitionInfos.values)    <span class="hljs-comment">// PartitionTopicInfo</span>
          allPartitionInfos ::= partition 
      fetcher <span class="hljs-keyword">match</span> {
        <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(f) =&gt; f.startConnections(allPartitionInfos, cluster)
      }
    }
</code></pre>
<p>&#x521B;&#x5EFA;Fetcher&#x662F;&#x4E3A; PartitionInfos&#x51C6;&#x5907;&#x5F00;&#x59CB;&#x8FDE;&#x63A5;, &#x5728;rebalance&#x65F6;&#x4E00;&#x5F00;&#x59CB;&#x8981;&#x5148; closeFetchers&#x5C31;&#x662F;&#x5173;&#x95ED;&#x5DF2;&#x7ECF;&#x5EFA;&#x7ACB;&#x7684;&#x8FDE;&#x63A5;.
relevantTopicThreadIdsMap&#x662F;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x8005;&#x7684; topic-&gt;threadIds,&#x8981;&#x4ECE;topicThreadIdAndQueues&#x8FC7;&#x6EE4;&#x51FA;&#x9700;&#x8981;&#x6E05;&#x9664;&#x7684; queues.</p>
<table>
<thead>
<tr>
<th>DataStructure</th>
<th>Explain</th>
</tr>
</thead>
<tbody>
<tr>
<td>relevantTopicThreadIdsMap</td>
<td>&#x6D88;&#x8D39;&#x8005;&#x6CE8;&#x518C;&#x7684;topic-&gt;threadIds</td>
</tr>
<tr>
<td>topicThreadIdAndQueues</td>
<td>&#x6D88;&#x8D39;&#x8005;&#x7684;(topic,threadId)-&gt;queue</td>
</tr>
<tr>
<td>messageStreams</td>
<td>&#x6D88;&#x8D39;&#x8005;&#x6CE8;&#x518C;&#x7684;topic-&gt;List[KafkaStream]&#x6D88;&#x606F;&#x6D41;</td>
</tr>
</tbody>
</table>
<p>&#x5173;&#x95ED;Fetcher&#x65F6;&#x8981;&#x6CE8;&#x610F;: &#x5148;&#x63D0;&#x4EA4;offset,&#x7136;&#x540E;&#x624D;&#x505C;&#x6B62;&#x6D88;&#x8D39;&#x8005;. &#x56E0;&#x4E3A;&#x5728;&#x505C;&#x6B62;&#x6D88;&#x8D39;&#x8005;&#x7684;&#x65F6;&#x5019;&#x5F53;&#x524D;&#x7684;&#x6570;&#x636E;&#x5757;&#x4E2D;&#x8FD8;&#x4F1A;&#x6709;&#x70B9;&#x6B8B;&#x7559;&#x6570;&#x636E;.
&#x56E0;&#x4E3A;&#x8FD9;&#x65F6;&#x5019;&#x8FD8;&#x6CA1;&#x6709;&#x91CA;&#x653E; partition&#x7684; ownership(&#x5373;partition&#x8FD8;&#x5F52;&#x5F53;&#x524D; consumer&#x6240;&#x6709;),&#x5F3A;&#x5236;&#x63D0;&#x4EA4;offset,
&#x8FD9;&#x6837;&#x62E5;&#x6709;&#x8FD9;&#x4E2A;partition&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7EBF;&#x7A0B;(rebalance&#x540E;),&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5DF2;&#x7ECF;&#x63D0;&#x4EA4;&#x7684;offset&#x4E86;,&#x786E;&#x4FDD;&#x4E0D;&#x4E2D;&#x65AD;.
&#x56E0;&#x4E3A;fetcher&#x7EBF;&#x7A0B;&#x5DF2;&#x7ECF;&#x5173;&#x95ED;&#x4E86;(stopConnections),&#x8FD9;&#x662F;&#x6D88;&#x8D39;&#x8005;&#x80FD;&#x5F97;&#x5230;&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x5757;,&#x4EE5;&#x540E;&#x4E0D;&#x4F1A;&#x6709;&#x4E86;,&#x76F4;&#x5230;&#x5E73;&#x8861;&#x7ED3;&#x675F;,fetcher&#x91CD;&#x65B0;&#x5F00;&#x59CB;</p>
<blockquote>
<p>topicThreadIdAndQueues&#x6765;&#x81EA;&#x4E8E; topicThreadIds,&#x6240;&#x4EE5;&#x5B83;&#x7684; topic&#x5E94;&#x8BE5;&#x90FD;&#x5728; relevantTopicThreadIdsMap&#x7684; topics&#x4E2D;.
&#x4E3A;&#x4EC0;&#x4E48;&#x8FD8;&#x8981;&#x8FC7;&#x6EE4;&#x5462;? &#x6CE8;&#x91CA;&#x4E2D;&#x8BF4;&#x5230;&#x5728;&#x672C;&#x6B21;&#x5E73;&#x8861;&#x4E4B;&#x540E;,&#x53EA;&#x9700;&#x8981;&#x6E05;&#x7406;&#x53EF;&#x80FD;&#x4E0D;&#x518D;&#x5C5E;&#x4E8E;&#x8FD9;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7684;&#x961F;&#x5217;(&#x90E8;&#x5206;&#x7684;topicPartition&#x6293;&#x53D6;&#x961F;&#x5217;).</p>
</blockquote>
<pre><code class="lang-scala">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">closeFetchers</span></span>(cluster: <span class="hljs-type">Cluster</span>, messageStreams: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[_,_]]], relevantTopicThreadIdsMap: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Set</span>[<span class="hljs-type">ConsumerThreadId</span>]]) {
      <span class="hljs-comment">// only clear the fetcher queues for certain topic partitions that *might* no longer be served by this consumer after this rebalancing attempt</span>
      <span class="hljs-keyword">val</span> queuesTobeCleared = topicThreadIdAndQueues.filter(q =&gt; relevantTopicThreadIdsMap.contains(q._1._1)).map(q =&gt; q._2)
      closeFetchersForQueues(cluster, messageStreams, queuesTobeCleared)
    }
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">closeFetchersForQueues</span></span>(cluster: <span class="hljs-type">Cluster</span>, messageStreams: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[_,_]]], queuesToBeCleared: <span class="hljs-type">Iterable</span>[<span class="hljs-type">BlockingQueue</span>[<span class="hljs-type">FetchedDataChunk</span>]]) {
      <span class="hljs-keyword">val</span> allPartitionInfos = topicRegistry.values.map(p =&gt; p.values).flatten
      fetcher <span class="hljs-keyword">match</span> {
        <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(f) =&gt;
          f.stopConnections     <span class="hljs-comment">// &#x505C;&#x6B62;FetcherManager&#x7BA1;&#x7406;&#x7684;&#x6240;&#x6709; Fetcher&#x7EBF;&#x7A0B;</span>
          clearFetcherQueues(allPartitionInfos, cluster, queuesToBeCleared, messageStreams)
          <span class="hljs-keyword">if</span> (config.autoCommitEnable) commitOffsets(<span class="hljs-literal">true</span>)
      }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clearFetcherQueues</span></span>(topicInfos: <span class="hljs-type">Iterable</span>[<span class="hljs-type">PartitionTopicInfo</span>], cluster: <span class="hljs-type">Cluster</span>, queuesTobeCleared: <span class="hljs-type">Iterable</span>[<span class="hljs-type">BlockingQueue</span>[<span class="hljs-type">FetchedDataChunk</span>]], messageStreams: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>,<span class="hljs-type">List</span>[<span class="hljs-type">KafkaStream</span>[_,_]]]) {
      <span class="hljs-comment">// Clear all but the currently iterated upon chunk in the consumer thread&apos;s queue</span>
      queuesTobeCleared.foreach(_.clear)
      <span class="hljs-comment">// Also clear the currently iterated upon chunk in the consumer threads</span>
      <span class="hljs-keyword">if</span>(messageStreams != <span class="hljs-literal">null</span>) messageStreams.foreach(_._2.foreach(s =&gt; s.clear()))
    }
</code></pre>
<blockquote>
<p>&#x95EE;&#x9898;:&#x65B0;&#x521B;&#x5EFA;&#x7684;ZKRebalancerListener&#x4E2D; kafkaMessageAndMetadataStreams(&#x5373;&#x8FD9;&#x91CC;&#x7684;messageStreams)&#x4E3A;&#x7A7A;&#x7684;Map.
&#x5982;&#x4F55;&#x6E05;&#x7A7A;&#x91CC;&#x9762;&#x7684;&#x6570;&#x636E;? &#x5B9E;&#x9645;&#x4E0A;KafkaStream&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x8FED;&#x4EE3;&#x5668;,&#x5728;&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x4F1A;&#x6709;&#x6570;&#x636E;&#x653E;&#x5165;&#x5230;&#x8FD9;&#x4E2A;&#x6D41;&#x4E2D;,&#x8FD9;&#x6837;&#x6D41;&#x5C31;&#x6709;&#x6570;&#x636E;&#x4E86;.</p>
</blockquote>
<h2 id="consumerfetchermanager">ConsumerFetcherManager</h2>
<p>topicInfos&#x662F;&#x4E0A;&#x4E00;&#x6B65; updateFetcher&#x7684; topicRegistry,&#x662F;&#x5206;&#x914D;&#x7ED9;&#x7ED9;consumer&#x7684;&#x6CE8;&#x518C;&#x4FE1;&#x606F;:topic-&gt;(partition-&gt;PartitionTopicInfo).
Fetcher&#x7EBF;&#x7A0B;&#x8981;&#x6293;&#x53D6;&#x6570;&#x636E;&#x5173;&#x5FC3;&#x7684;&#x662F; PartitionTopicInfo,&#x9996;&#x5148;&#x8981;&#x627E;&#x51FA;Partition Leader(&#x56E0;&#x4E3A;&#x53EA;&#x5411;Leader Partition&#x53D1;&#x8D77;&#x6293;&#x53D6;&#x8BF7;&#x6C42;).
&#x521D;&#x59CB;&#x65F6;&#x5047;&#x8BBE;&#x6240;&#x6709;topicInfos(PartitionTopicInfo)&#x90FD;&#x627E;&#x4E0D;&#x5230;Leader,&#x5373;&#x540C;&#x65F6;&#x52A0;&#x5165;partitionMap&#x548C; noLeaderPartitionSet.
&#x5728;LeaderFinderThread&#x7EBF;&#x7A0B;&#x4E2D;&#x5982;&#x679C;&#x627E;&#x5230; Leader,&#x5219;&#x4ECE;noLeaderPartitionSet&#x4E2D;&#x79FB;&#x9664;.</p>
<pre><code class="lang-scala">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startConnections</span></span>(topicInfos: <span class="hljs-type">Iterable</span>[<span class="hljs-type">PartitionTopicInfo</span>], cluster: <span class="hljs-type">Cluster</span>) {
    leaderFinderThread = <span class="hljs-keyword">new</span> <span class="hljs-type">LeaderFinderThread</span>(consumerIdString + <span class="hljs-string">&quot;-leader-finder-thread&quot;</span>)
    leaderFinderThread.start()

    inLock(lock) {
      partitionMap = topicInfos.map(tpi =&gt; (<span class="hljs-type">TopicAndPartition</span>(tpi.topic, tpi.partitionId), tpi)).toMap
      <span class="hljs-keyword">this</span>.cluster = cluster
      noLeaderPartitionSet ++= topicInfos.map(tpi =&gt; <span class="hljs-type">TopicAndPartition</span>(tpi.topic, tpi.partitionId))
      cond.signalAll()
    }
  }
</code></pre>
<p>ConsumerFetcherManager&#x7BA1;&#x7406;&#x4E86;&#x5F53;&#x524D; Consumer&#x7684;&#x6240;&#x6709; Fetcher&#x7EBF;&#x7A0B;.
&#x6CE8;&#x610F;ConsumerFetcherThread&#x6784;&#x9020;&#x51FD;&#x6570;&#x4E2D;&#x7684; partitionMap&#x548C;&#x6784;&#x5EFA; FetchRequest&#x65F6;&#x7684; partitionMap&#x662F;&#x4E0D;&#x540C;&#x7684;.
&#x4E0D;&#x8FC7;&#x5B83;&#x4EEC;&#x7684;&#x76F8;&#x540C;&#x70B9;&#x662F;&#x90FD;&#x6709;offset&#x4FE1;&#x606F;.&#x5E76;&#x4E14;&#x90FD;&#x6709;fetch&#x64CD;&#x4F5C;.</p>
<p><img src="20160127120246496" alt=""></p>
<h2 id="ref">Ref</h2>
<ul>
<li><a href="http://uohzoaix.github.io/studies" target="_blank">uohzoaix&apos; Homepage</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../Producer-scala/" class="navigation navigation-prev " aria-label="Previous page: Producer-Scala">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../Stream/" class="navigation navigation-next " aria-label="Next page: Stream">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Consumer","level":"1.2.3","depth":2,"next":{"title":"Stream","level":"1.2.4","depth":2,"path":"Kafka/Stream/README.md","ref":"./Kafka/Stream/README.md","articles":[]},"previous":{"title":"Producer-Scala","level":"1.2.2","depth":2,"path":"Kafka/Producer-scala/README.md","ref":"./Kafka/Producer-scala/README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Kafka/Consumer/README.md","mtime":"2017-05-03T05:59:16.281Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-05-03T06:07:17.133Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

